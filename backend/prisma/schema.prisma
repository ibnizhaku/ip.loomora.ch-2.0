// Loomora ERP - Complete Database Schema
// Swiss-compliant ERP with QR-Rechnung, HR, Projects, and more

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
  READONLY
}

enum DocumentStatus {
  DRAFT
  SENT
  CONFIRMED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  TWINT
  PAYPAL
  CASH
  INVOICE
}

enum VatRate {
  STANDARD    // 8.1%
  REDUCED     // 2.6%
  SPECIAL     // 3.8%
  EXEMPT      // 0%
}

enum ReminderLevel {
  FIRST
  SECOND
  THIRD
  FOURTH
  FIFTH
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum EmployeeStatus {
  ACTIVE
  VACATION
  SICK
  INACTIVE
}

enum AbsenceType {
  VACATION
  SICK
  UNPAID
  MATERNITY
  PATERNITY
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  MEETING
  CALL
  DEADLINE
  REMINDER
  VACATION
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

// ============================================
// CORE / SYSTEM
// ============================================

model Company {
  id            String   @id @default(cuid())
  name          String
  legalName     String?
  street        String?
  zipCode       String?
  city          String?
  country       String   @default("CH")
  phone         String?
  email         String?
  website       String?
  vatNumber     String?  // CHE-123.456.789
  iban          String?
  bic           String?
  bankName      String?
  logoUrl       String?
  
  // Settings as JSON
  settings      Json     @default("{}")
  
  // Numbering (current counters)
  invoiceCounter    Int  @default(0)
  quoteCounter      Int  @default(0)
  orderCounter      Int  @default(0)
  deliveryCounter   Int  @default(0)
  creditNoteCounter Int  @default(0)
  purchaseCounter   Int  @default(0)
  projectCounter    Int  @default(0)
  employeeCounter   Int  @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  users         User[]
  customers     Customer[]
  suppliers     Supplier[]
  products      Product[]
  categories    ProductCategory[]
  quotes        Quote[]
  orders        Order[]
  invoices      Invoice[]
  creditNotes   CreditNote[]
  deliveryNotes DeliveryNote[]
  purchaseOrders PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  payments      Payment[]
  bankAccounts  BankAccount[]
  chartOfAccounts ChartOfAccount[]
  journalEntries JournalEntry[]
  projects      Project[]
  employees     Employee[]
  departments   Department[]
  timeEntries   TimeEntry[]
  calendarEvents CalendarEvent[]
  tasks         Task[]
  leads         Lead[]
  campaigns     Campaign[]
  
  @@map("companies")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  avatarUrl     String?
  role          UserRole @default(EMPLOYEE)
  isActive      Boolean  @default(true)
  twoFactorEnabled Boolean @default(false)
  lastLoginAt   DateTime?
  refreshToken  String?
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  createdQuotes     Quote[]    @relation("QuoteCreator")
  createdOrders     Order[]    @relation("OrderCreator")
  createdInvoices   Invoice[]  @relation("InvoiceCreator")
  assignedTasks     Task[]     @relation("TaskAssignee")
  createdTasks      Task[]     @relation("TaskCreator")
  timeEntries       TimeEntry[]
  createdProjects   Project[]  @relation("ProjectCreator")
  managedProjects   Project[]  @relation("ProjectManager")
  eventAttendances  EventAttendee[]
  
  @@index([companyId])
  @@index([email])
  @@map("users")
}

model Setting {
  id        String   @id @default(cuid())
  companyId String
  key       String
  value     Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([companyId, key])
  @@map("settings")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  title       String
  message     String
  type        String   // info, warning, error, success
  isRead      Boolean  @default(false)
  link        String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@map("notifications")
}

// ============================================
// CRM / CONTACTS
// ============================================

model Customer {
  id              String   @id @default(cuid())
  number          String   // KD-0001
  name            String
  companyName     String?
  salutation      String?
  street          String?
  zipCode         String?
  city            String?
  country         String   @default("CH")
  phone           String?
  mobile          String?
  email           String?
  website         String?
  vatNumber       String?
  
  // Payment terms
  paymentTermDays Int      @default(30)
  creditLimit     Decimal? @db.Decimal(12, 2)
  discount        Decimal  @default(0) @db.Decimal(5, 2)  // Default discount %
  
  notes           String?
  isActive        Boolean  @default(true)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contacts        Contact[]
  quotes          Quote[]
  orders          Order[]
  invoices        Invoice[]
  creditNotes     CreditNote[]
  deliveryNotes   DeliveryNote[]
  payments        Payment[]
  projects        Project[]
  calculations    Calculation[]
  serviceTickets  ServiceTicket[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([email])
  @@map("customers")
}

model Supplier {
  id              String   @id @default(cuid())
  number          String   // LF-0001
  name            String
  companyName     String?
  street          String?
  zipCode         String?
  city            String?
  country         String   @default("CH")
  phone           String?
  email           String?
  website         String?
  vatNumber       String?
  iban            String?
  
  paymentTermDays Int      @default(30)
  rating          Int?     @default(0)  // 0-5 stars
  notes           String?
  isActive        Boolean  @default(true)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contacts        Contact[]
  purchaseOrders  PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  products        Product[]
  payments        Payment[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("suppliers")
}

model Contact {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  position    String?
  phone       String?
  mobile      String?
  email       String?
  isPrimary   Boolean  @default(false)
  notes       String?
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  serviceTickets ServiceTicket[]
  
  @@index([customerId])
  @@index([supplierId])
  @@map("contacts")
}

model Lead {
  id              String     @id @default(cuid())
  name            String
  companyName     String?
  email           String?
  phone           String?
  source          String?    // Website, Referral, Cold Call, etc.
  status          LeadStatus @default(NEW)
  value           Decimal?   @db.Decimal(12, 2)
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
  @@index([status])
  @@map("leads")
}

// ============================================
// PRODUCTS / INVENTORY
// ============================================

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@map("product_categories")
}

model Product {
  id              String   @id @default(cuid())
  sku             String   // ART-0001
  name            String
  description     String?
  
  unit            String   @default("Stk")  // Stk, kg, m, m², lfm, h
  
  purchasePrice   Decimal  @default(0) @db.Decimal(12, 2)
  salePrice       Decimal  @db.Decimal(12, 2)
  vatRate         VatRate  @default(STANDARD)
  
  // Inventory
  stockQuantity   Decimal  @default(0) @db.Decimal(12, 3)
  minStock        Decimal  @default(0) @db.Decimal(12, 3)
  maxStock        Decimal? @db.Decimal(12, 3)
  reservedStock   Decimal  @default(0) @db.Decimal(12, 3)
  
  // Dimensions (for shipping)
  weight          Decimal? @db.Decimal(10, 3)  // kg
  length          Decimal? @db.Decimal(10, 2)  // cm
  width           Decimal? @db.Decimal(10, 2)
  height          Decimal? @db.Decimal(10, 2)
  
  imageUrl        String?
  isActive        Boolean  @default(true)
  isService       Boolean  @default(false)
  
  categoryId      String?
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  quoteItems      QuoteItem[]
  orderItems      OrderItem[]
  invoiceItems    InvoiceItem[]
  deliveryNoteItems DeliveryNoteItem[]
  creditNoteItems CreditNoteItem[]
  goodsReceiptItems GoodsReceiptItem[]
  inventoryMovements InventoryMovement[]
  bomItems        BomItem[]
  
  @@unique([companyId, sku])
  @@index([companyId])
  @@index([categoryId])
  @@map("products")
}

model InventoryMovement {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  type        String   // IN, OUT, ADJUSTMENT, RETURN
  quantity    Decimal  @db.Decimal(12, 3)
  reference   String?  // Order number, etc.
  notes       String?
  
  createdAt   DateTime @default(now())
  
  @@index([productId])
  @@map("inventory_movements")
}

// ============================================
// SALES: QUOTES
// ============================================

model Quote {
  id              String   @id @default(cuid())
  number          String   // AN-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  date            DateTime @default(now())
  validUntil      DateTime
  status          DocumentStatus @default(DRAFT)
  
  // Address (snapshot)
  billingAddress  Json?
  shippingAddress Json?
  
  // Totals
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  internalNotes   String?
  terms           String?
  
  createdById     String
  createdBy       User     @relation("QuoteCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           QuoteItem[]
  orders          Order[]  // Converted orders
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     VatRate  @default(STANDARD)
  total       Decimal  @db.Decimal(12, 2)
  
  @@index([quoteId])
  @@map("quote_items")
}

// ============================================
// SALES: ORDERS
// ============================================

model Order {
  id              String   @id @default(cuid())
  number          String   // AU-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  quoteId         String?
  quote           Quote?   @relation(fields: [quoteId], references: [id])
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  date            DateTime @default(now())
  deliveryDate    DateTime?
  status          DocumentStatus @default(DRAFT)
  
  billingAddress  Json?
  shippingAddress Json?
  
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  internalNotes   String?
  
  createdById     String
  createdBy       User     @relation("OrderCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           OrderItem[]
  invoices        Invoice[]
  deliveryNotes   DeliveryNote[]
  productionOrders ProductionOrder[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     VatRate  @default(STANDARD)
  total       Decimal  @db.Decimal(12, 2)
  
  // Delivery tracking
  deliveredQty Decimal @default(0) @db.Decimal(12, 3)
  
  @@index([orderId])
  @@map("order_items")
}

// ============================================
// SALES: DELIVERY NOTES
// ============================================

enum DeliveryNoteStatus {
  DRAFT
  SHIPPED
  DELIVERED
  CANCELLED
}

model DeliveryNote {
  id              String   @id @default(cuid())
  number          String   // LS-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  status          DeliveryNoteStatus @default(DRAFT)
  date            DateTime @default(now())
  deliveryDate    DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  deliveryAddress String?
  shippingAddress Json?
  trackingNumber  String?
  carrier         String?
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           DeliveryNoteItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("delivery_notes")
}

model DeliveryNoteItem {
  id              String   @id @default(cuid())
  deliveryNoteId  String
  deliveryNote    DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  
  position        Int
  productId       String?
  product         Product? @relation(fields: [productId], references: [id])
  description     String?
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  
  @@index([deliveryNoteId])
  @@index([productId])
  @@map("delivery_note_items")
}

// ============================================
// SALES: INVOICES
// ============================================

model Invoice {
  id              String   @id @default(cuid())
  number          String   // RE-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  date            DateTime @default(now())
  dueDate         DateTime
  paidAt          DateTime?
  status          InvoiceStatus @default(DRAFT)
  
  billingAddress  Json?
  
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatRate         Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2)
  
  // Swiss QR-Rechnung
  qrReference     String?  // 26-digit reference
  qrIban          String?
  
  notes           String?
  internalNotes   String?
  paymentTerms    String?
  
  createdById     String
  createdBy       User     @relation("InvoiceCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           InvoiceItem[]
  payments        Payment[]
  reminders       Reminder[]
  creditNotes     CreditNote[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount   Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  
  @@index([invoiceId])
  @@map("invoice_items")
}

enum ReminderStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

model Reminder {
  id          String   @id @default(cuid())
  number      String   // MHN-2024-0001
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  level       Int      @default(1)  // 1-5 (Swiss 5-level dunning)
  status      ReminderStatus @default(DRAFT)
  sentAt      DateTime?
  sendMethod  String?  // EMAIL, POST, BOTH
  dueDate     DateTime
  fee         Decimal  @default(0) @db.Decimal(10, 2)  // Mahngebühr
  totalWithFee Decimal @default(0) @db.Decimal(12, 2) // Original + fee
  notes       String?
  
  companyId   String
  
  createdAt   DateTime @default(now())
  
  @@unique([companyId, number])
  @@index([invoiceId])
  @@index([companyId])
  @@index([status])
  @@map("reminders")
}

// ============================================
// SALES: CREDIT NOTES
// ============================================

enum CreditNoteStatus {
  DRAFT
  ISSUED
  APPLIED
  CANCELLED
}

enum CreditNoteReason {
  RETURN
  PRICE_ADJUSTMENT
  QUANTITY_DIFFERENCE
  QUALITY_ISSUE
  GOODWILL
  OTHER
}

model CreditNote {
  id              String   @id @default(cuid())
  number          String   // GS-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  invoiceId       String?
  invoice         Invoice? @relation(fields: [invoiceId], references: [id])
  
  status          CreditNoteStatus @default(DRAFT)
  reason          CreditNoteReason?
  reasonText      String?
  issueDate       DateTime @default(now())
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatRate         Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           CreditNoteItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("credit_notes")
}

model CreditNoteItem {
  id            String   @id @default(cuid())
  creditNoteId  String
  creditNote    CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  
  position      Int
  productId     String?
  product       Product? @relation(fields: [productId], references: [id])
  description   String?
  quantity      Decimal  @db.Decimal(12, 3)
  unit          String
  unitPrice     Decimal  @db.Decimal(12, 2)
  vatRate       Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount     Decimal  @db.Decimal(12, 2)
  total         Decimal  @db.Decimal(12, 2)
  
  @@index([creditNoteId])
  @@index([productId])
  @@map("credit_note_items")
}

// ============================================
// PURCHASING
// ============================================

model PurchaseOrder {
  id              String   @id @default(cuid())
  number          String   // BE-2024-0001
  
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  date            DateTime @default(now())
  expectedDate    DateTime?
  status          DocumentStatus @default(DRAFT)
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           PurchaseOrderItem[]
  purchaseInvoices PurchaseInvoice[]
  goodsReceipts   GoodsReceipt[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  position        Int
  description     String
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  unitPrice       Decimal  @db.Decimal(12, 2)
  vatRate         VatRate  @default(STANDARD)
  total           Decimal  @db.Decimal(12, 2)
  
  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model PurchaseInvoice {
  id              String   @id @default(cuid())
  number          String   // External invoice number
  
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  
  date            DateTime
  dueDate         DateTime
  status          InvoiceStatus @default(DRAFT)
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2)
  
  documentUrl     String?  // Uploaded PDF
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  payments        Payment[]
  
  @@index([companyId])
  @@index([supplierId])
  @@map("purchase_invoices")
}

// ============================================
// PURCHASING: GOODS RECEIPTS
// ============================================

enum GoodsReceiptStatus {
  PENDING
  PARTIAL
  COMPLETE
  CANCELLED
}

enum QualityStatus {
  NOT_CHECKED
  PASSED
  FAILED
  PARTIAL
}

model GoodsReceipt {
  id                  String   @id @default(cuid())
  number              String   // WE-2024-0001
  
  purchaseOrderId     String
  purchaseOrder       PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  
  status              GoodsReceiptStatus @default(PENDING)
  receiptDate         DateTime @default(now())
  deliveryNoteNumber  String?
  carrier             String?
  notes               String?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  items               GoodsReceiptItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([purchaseOrderId])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id                String   @id @default(cuid())
  goodsReceiptId    String
  goodsReceipt      GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  
  position          Int
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  
  orderedQuantity   Decimal  @db.Decimal(12, 3)
  receivedQuantity  Decimal  @db.Decimal(12, 3)
  unit              String
  
  qualityStatus     QualityStatus @default(NOT_CHECKED)
  qualityNotes      String?
  batchNumber       String?
  serialNumber      String?
  storageLocation   String?
  
  @@index([goodsReceiptId])
  @@index([productId])
  @@map("goods_receipt_items")
}

// ============================================
// FINANCE: PAYMENTS
// ============================================

enum PaymentType {
  INCOMING  // Debitorenzahlung
  OUTGOING  // Kreditorenzahlung
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model Payment {
  id          String   @id @default(cuid())
  number      String   // ZE-2024-00001 or ZA-2024-00001
  
  type        PaymentType @default(INCOMING)
  status      PaymentStatus @default(PENDING)
  
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  
  purchaseInvoiceId String?
  purchaseInvoice   PurchaseInvoice? @relation(fields: [purchaseInvoiceId], references: [id])
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  paymentDate DateTime @default(now())
  amount      Decimal  @db.Decimal(12, 2)
  method      String   // BANK_TRANSFER, CASH, etc.
  reference   String?  // Bank reference, transaction ID
  qrReference String?  // Swiss QR reference for matching
  notes       String?
  
  bankAccountId String?
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([invoiceId])
  @@index([purchaseInvoiceId])
  @@index([qrReference])
  @@index([status])
  @@map("payments")
}

// ============================================
// FINANCE: BANKING
// ============================================

model BankAccount {
  id          String   @id @default(cuid())
  name        String
  iban        String
  bic         String?
  bankName    String?
  currency    String   @default("CHF")
  balance     Decimal  @default(0) @db.Decimal(14, 2)
  isDefault   Boolean  @default(false)
  
  // For QR-Rechnung
  qrIban      String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  transactions BankTransaction[]
  payments    Payment[]
  
  @@index([companyId])
  @@map("bank_accounts")
}

model BankTransaction {
  id              String   @id @default(cuid())
  bankAccountId   String
  bankAccount     BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  
  date            DateTime
  valueDate       DateTime?
  amount          Decimal  @db.Decimal(14, 2)
  currency        String   @default("CHF")
  description     String?
  reference       String?  // camt.054 reference
  counterpartName String?
  counterpartIban String?
  
  isMatched       Boolean  @default(false)
  matchedPaymentId String?
  
  importedAt      DateTime @default(now())
  
  @@index([bankAccountId])
  @@index([reference])
  @@map("bank_transactions")
}

// ============================================
// FINANCE: ACCOUNTING
// ============================================

model ChartOfAccount {
  id          String   @id @default(cuid())
  number      String   // 4-digit: 1000, 1100, etc.
  name        String
  type        String   // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  parentId    String?
  parent      ChartOfAccount? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    ChartOfAccount[] @relation("AccountHierarchy")
  
  isActive    Boolean  @default(true)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  debitEntries  JournalEntry[] @relation("DebitAccount")
  creditEntries JournalEntry[] @relation("CreditAccount")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("chart_of_accounts")
}

model JournalEntry {
  id              String   @id @default(cuid())
  date            DateTime
  
  debitAccountId  String
  debitAccount    ChartOfAccount @relation("DebitAccount", fields: [debitAccountId], references: [id])
  
  creditAccountId String
  creditAccount   ChartOfAccount @relation("CreditAccount", fields: [creditAccountId], references: [id])
  
  amount          Decimal  @db.Decimal(14, 2)
  description     String?
  reference       String?  // Invoice number, etc.
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([companyId])
  @@index([date])
  @@map("journal_entries")
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id              String   @id @default(cuid())
  number          String   // PRJ-2024-0001
  name            String
  description     String?
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  status          ProjectStatus @default(PLANNING)
  priority        ProjectPriority @default(MEDIUM)
  
  startDate       DateTime?
  endDate         DateTime?
  
  budget          Decimal? @db.Decimal(12, 2)
  spent           Decimal  @default(0) @db.Decimal(12, 2)
  
  progress        Int      @default(0)  // 0-100
  
  createdById     String
  createdBy       User     @relation("ProjectCreator", fields: [createdById], references: [id])
  
  managerId       String?
  manager         User?    @relation("ProjectManager", fields: [managerId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  tasks           Task[]
  timeEntries     TimeEntry[]
  orders          Order[]
  purchaseOrders  PurchaseOrder[]
  members         ProjectMember[]
  boms            BillOfMaterial[]
  productionOrders ProductionOrder[]
  calculations    Calculation[]
  serviceTickets  ServiceTicket[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  
  role      String?  // Developer, Designer, etc.
  
  createdAt DateTime @default(now())
  
  @@unique([projectId, employeeId])
  @@index([projectId])
  @@map("project_members")
}

// ============================================
// TASKS
// ============================================

model Task {
  id              String   @id @default(cuid())
  title           String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  status          TaskStatus @default(TODO)
  priority        TaskPriority @default(MEDIUM)
  
  dueDate         DateTime?
  estimatedHours  Decimal? @db.Decimal(6, 2)
  
  assigneeId      String?
  assignee        User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  
  createdById     String
  createdBy       User     @relation("TaskCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  timeEntries     TimeEntry[]
  tags            TaskTag[]
  subtasks        Subtask[]
  
  @@index([companyId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@map("tasks")
}

model TaskTag {
  id      String @id @default(cuid())
  taskId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  name    String
  
  @@index([taskId])
  @@map("task_tags")
}

model Subtask {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  title       String
  isCompleted Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@map("subtasks")
}

// ============================================
// TIME TRACKING
// ============================================

model TimeEntry {
  id          String   @id @default(cuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])
  
  description String?
  date        DateTime @default(now())
  duration    Int      // in minutes
  
  isBillable  Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@map("time_entries")
}

// ============================================
// CALENDAR
// ============================================

model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  
  type        EventType @default(MEETING)
  
  startTime   DateTime
  endTime     DateTime?
  isAllDay    Boolean  @default(false)
  
  location    String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attendees   EventAttendee[]
  reminders   EventReminder[]
  
  @@index([companyId])
  @@index([startTime])
  @@map("calendar_events")
}

model EventAttendee {
  id      String @id @default(cuid())
  eventId String
  event   CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  
  status  String @default("pending") // pending, accepted, declined
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@map("event_attendees")
}

model EventReminder {
  id          String   @id @default(cuid())
  eventId     String
  event       CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  minutesBefore Int
  method      String   // email, notification
  
  @@index([eventId])
  @@map("event_reminders")
}

// ============================================
// HR: EMPLOYEES
// ============================================

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  managerId   String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  employees   Employee[]
  
  @@index([companyId])
  @@map("departments")
}

model Employee {
  id              String   @id @default(cuid())
  number          String   // MA-0001
  
  firstName       String
  lastName        String
  email           String?
  phone           String?
  mobile          String?
  
  position        String?
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  
  status          EmployeeStatus @default(ACTIVE)
  
  hireDate        DateTime?
  terminationDate DateTime?
  
  // Swiss-specific
  ahvNumber       String?  // AHV-Nummer
  dateOfBirth     DateTime?
  nationality     String?
  maritalStatus   String?
  childrenCount   Int      @default(0)
  
  // Work details
  employmentType  String?  // Vollzeit, Teilzeit
  workloadPercent Int      @default(100)
  
  // Bank details
  iban            String?
  
  avatarUrl       String?
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contracts       EmployeeContract[]
  absences        Absence[]
  payslips        Payslip[]
  trainingParticipations TrainingParticipant[]
  travelExpenses  TravelExpense[]
  projectMemberships ProjectMember[]
  productionOperations ProductionOperation[]
  qualityChecks   QualityCheck[]
  serviceTickets  ServiceTicket[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([departmentId])
  @@map("employees")
}

model EmployeeContract {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  contractType    String   // Unbefristet, Befristet, Temporär
  startDate       DateTime
  endDate         DateTime?
  
  // Salary (Swiss GAV Metallbau)
  salaryType      String   // Monatslohn, Stundenlohn
  baseSalary      Decimal  @db.Decimal(12, 2)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  
  // Swiss wage class (GAV Metallbau)
  wageClass       String?  // A, B, C, D, E, F
  
  workHoursPerWeek Decimal @default(42.5) @db.Decimal(4, 1)
  vacationDays    Int      @default(25)
  
  probationEnd    DateTime?
  noticePeriod    String?  // 1 Monat, 2 Monate, etc.
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@map("employee_contracts")
}

model Absence {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  type            AbsenceType
  status          AbsenceStatus @default(PENDING)
  
  startDate       DateTime
  endDate         DateTime
  
  days            Decimal  @db.Decimal(4, 1)  // Can be 0.5 for half days
  
  reason          String?
  notes           String?
  
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@index([startDate])
  @@map("absences")
}

// ============================================
// HR: PAYROLL
// ============================================

model Payslip {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  period          DateTime // Month/Year
  
  grossSalary     Decimal  @db.Decimal(12, 2)
  netSalary       Decimal  @db.Decimal(12, 2)
  
  // Swiss social security deductions
  ahvDeduction    Decimal  @default(0) @db.Decimal(10, 2) // AHV/IV/EO
  alvDeduction    Decimal  @default(0) @db.Decimal(10, 2) // ALV
  nbuDeduction    Decimal  @default(0) @db.Decimal(10, 2) // NBU
  bvgDeduction    Decimal  @default(0) @db.Decimal(10, 2) // BVG (Pensionskasse)
  taxDeduction    Decimal  @default(0) @db.Decimal(10, 2) // Quellensteuer
  
  hoursWorked     Decimal? @db.Decimal(6, 2)
  overtime        Decimal? @db.Decimal(6, 2)
  vacationDays    Decimal? @db.Decimal(4, 1)
  sickDays        Decimal? @db.Decimal(4, 1)
  
  notes           String?
  isPaid          Boolean  @default(false)
  paidAt          DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           PayslipItem[]
  
  @@index([employeeId])
  @@index([period])
  @@map("payslips")
}

model PayslipItem {
  id          String   @id @default(cuid())
  payslipId   String
  payslip     Payslip  @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  
  type        String   // Grundlohn, Zuschlag, Abzug, Bonus
  description String
  amount      Decimal  @db.Decimal(12, 2)
  isDeduction Boolean  @default(false)
  
  @@index([payslipId])
  @@map("payslip_items")
}

// ============================================
// HR: TRAINING
// ============================================

model Training {
  id              String   @id @default(cuid())
  title           String
  description     String?
  
  category        String?  // Sicherheit, Fachlich, Soft Skills
  
  startDate       DateTime
  endDate         DateTime?
  
  location        String?
  trainer         String?
  
  maxParticipants Int?
  budget          Decimal? @db.Decimal(12, 2)
  
  status          String   @default("planned") // planned, ongoing, completed, cancelled
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  participants    TrainingParticipant[]
  
  @@map("trainings")
}

model TrainingParticipant {
  id          String   @id @default(cuid())
  trainingId  String
  training    Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  status      String   @default("registered") // registered, waitlist, attended, cancelled
  
  createdAt   DateTime @default(now())
  
  @@unique([trainingId, employeeId])
  @@index([trainingId])
  @@map("training_participants")
}

// ============================================
// HR: TRAVEL EXPENSES
// ============================================

model TravelExpense {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  date            DateTime
  description     String
  
  // Swiss rates
  kilometers      Decimal? @db.Decimal(8, 2)
  kmRate          Decimal  @default(0.70) @db.Decimal(4, 2) // CHF 0.70/km
  
  mealAllowance   Decimal? @db.Decimal(10, 2)
  accommodation   Decimal? @db.Decimal(10, 2)
  otherExpenses   Decimal? @db.Decimal(10, 2)
  
  totalAmount     Decimal  @db.Decimal(12, 2)
  
  status          String   @default("pending") // pending, approved, rejected, paid
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  
  receiptUrl      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@index([date])
  @@map("travel_expenses")
}

// ============================================
// MARKETING
// ============================================

model Campaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  
  type            String   // Email, Social, Event
  status          String   @default("draft") // draft, active, paused, completed
  
  startDate       DateTime?
  endDate         DateTime?
  
  budget          Decimal? @db.Decimal(12, 2)
  spent           Decimal  @default(0) @db.Decimal(12, 2)
  
  targetAudience  String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
  @@map("campaigns")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id          String   @id @default(cuid())
  userId      String?
  action      String   // CREATE, UPDATE, DELETE
  entityType  String   // invoice, customer, etc.
  entityId    String
  oldValue    Json?
  newValue    Json?
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// PRODUCTION: BILL OF MATERIALS
// ============================================

model BillOfMaterial {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  isTemplate  Boolean  @default(false)
  category    String?  // Treppe, Geländer, Tor, etc.
  
  companyId   String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  items           BomItem[]
  productionOrders ProductionOrder[]
  calculations    Calculation[]
  
  @@index([companyId])
  @@index([projectId])
  @@map("bill_of_materials")
}

model BomItem {
  id          String   @id @default(cuid())
  bomId       String
  bom         BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)
  
  type        String   // MATERIAL, LABOR, EXTERNAL
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  
  hours       Decimal? @db.Decimal(10, 2)  // For labor items
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  total       Decimal  @db.Decimal(12, 2)
  sortOrder   Int      @default(0)
  
  @@index([bomId])
  @@index([productId])
  @@map("bom_items")
}

// ============================================
// PRODUCTION: PRODUCTION ORDERS
// ============================================

enum ProductionOrderStatus {
  PLANNED
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum ProductionPriority {
  HIGH
  MEDIUM
  LOW
}

model ProductionOrder {
  id              String   @id @default(cuid())
  number          String   // WA-2024-0001
  name            String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  bomId           String?
  bom             BillOfMaterial? @relation(fields: [bomId], references: [id])
  
  status          ProductionOrderStatus @default(PLANNED)
  priority        ProductionPriority @default(MEDIUM)
  
  quantity        Int      @default(1)
  
  plannedStartDate DateTime
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  
  notes           String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  operations      ProductionOperation[]
  qualityChecks   QualityCheck[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([projectId])
  @@index([status])
  @@map("production_orders")
}

model ProductionOperation {
  id                  String   @id @default(cuid())
  productionOrderId   String
  productionOrder     ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  
  name                String
  description         String?
  workstation         String?  // CNC, Schweissen, Montage, etc.
  
  plannedHours        Decimal  @db.Decimal(10, 2)
  actualHours         Decimal  @default(0) @db.Decimal(10, 2)
  
  assignedEmployeeId  String?
  assignedEmployee    Employee? @relation(fields: [assignedEmployeeId], references: [id])
  
  status              String   @default("pending")  // pending, in_progress, completed
  sortOrder           Int      @default(0)
  
  @@index([productionOrderId])
  @@index([assignedEmployeeId])
  @@map("production_operations")
}

// ============================================
// PRODUCTION: CALCULATIONS
// ============================================

enum CalculationStatus {
  DRAFT
  CALCULATED
  APPROVED
  TRANSFERRED
}

model Calculation {
  id              String   @id @default(cuid())
  number          String   // KA-2024-0001
  name            String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  bomId           String?
  bom             BillOfMaterial? @relation(fields: [bomId], references: [id])
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  quoteId         String?  // Link to created quote
  
  status          CalculationStatus @default(DRAFT)
  
  // Markup percentages (Swiss Metallbau defaults)
  materialMarkup  Decimal  @default(15) @db.Decimal(5, 2)
  laborMarkup     Decimal  @default(10) @db.Decimal(5, 2)
  overheadPercent Decimal  @default(8) @db.Decimal(5, 2)
  profitMargin    Decimal  @default(12) @db.Decimal(5, 2)
  riskMargin      Decimal  @default(5) @db.Decimal(5, 2)
  discount        Decimal  @default(0) @db.Decimal(5, 2)
  
  totalCost       Decimal? @db.Decimal(12, 2)
  totalPrice      Decimal? @db.Decimal(12, 2)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           CalculationItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([projectId])
  @@index([customerId])
  @@map("calculations")
}

model CalculationItem {
  id              String   @id @default(cuid())
  calculationId   String
  calculation     Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  
  type            String   // MATERIAL, LABOR, EXTERNAL, OVERHEAD
  productId       String?
  description     String
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  unitCost        Decimal  @db.Decimal(12, 2)
  
  hours           Decimal? @db.Decimal(10, 2)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  
  total           Decimal  @db.Decimal(12, 2)
  sortOrder       Int      @default(0)
  
  @@index([calculationId])
  @@map("calculation_items")
}

// ============================================
// QUALITY CONTROL
// ============================================

enum QualityCheckType {
  INCOMING
  IN_PROCESS
  FINAL
}

enum QualityCheckStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  CONDITIONAL
}

model QualityChecklist {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("FINAL")  // INCOMING, IN_PROCESS, FINAL
  category    String?  // Schweissnaht, Massgenauigkeit, Oberfläche
  
  companyId   String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  items       ChecklistItem[]
  checks      QualityCheck[]
  
  @@index([companyId])
  @@map("quality_checklists")
}

model ChecklistItem {
  id          String   @id @default(cuid())
  checklistId String
  checklist   QualityChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  required    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  // Relations
  results     CheckResult[]
  
  @@index([checklistId])
  @@map("checklist_items")
}

model QualityCheck {
  id                  String   @id @default(cuid())
  number              String   // QC-2024-0001
  
  checklistId         String
  checklist           QualityChecklist @relation(fields: [checklistId], references: [id])
  
  productionOrderId   String?
  productionOrder     ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  
  goodsReceiptId      String?
  
  type                String   // INCOMING, IN_PROCESS, FINAL
  status              String   @default("PENDING")
  
  inspectorId         String?
  inspector           Employee? @relation(fields: [inspectorId], references: [id])
  
  notes               String?
  completedAt         DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  results             CheckResult[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([checklistId])
  @@index([productionOrderId])
  @@index([status])
  @@map("quality_checks")
}

model CheckResult {
  id              String   @id @default(cuid())
  qualityCheckId  String
  qualityCheck    QualityCheck @relation(fields: [qualityCheckId], references: [id], onDelete: Cascade)
  
  checklistItemId String
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id])
  
  passed          Boolean
  notes           String?
  measuredValue   String?
  photoUrls       String[] @default([])
  
  createdAt       DateTime @default(now())
  
  @@unique([qualityCheckId, checklistItemId])
  @@index([qualityCheckId])
  @@map("check_results")
}

// ============================================
// SERVICE TICKETS
// ============================================

enum ServiceTicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

enum ServiceTicketPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum ServiceType {
  REPAIR
  MAINTENANCE
  INSTALLATION
  INSPECTION
  WARRANTY
}

model ServiceTicket {
  id                  String   @id @default(cuid())
  number              String   // ST-2024-0001
  title               String
  description         String
  
  customerId          String
  customer            Customer @relation(fields: [customerId], references: [id])
  
  contactId           String?
  contact             Contact? @relation(fields: [contactId], references: [id])
  
  projectId           String?
  project             Project? @relation(fields: [projectId], references: [id])
  
  serviceType         ServiceType
  priority            ServiceTicketPriority @default(MEDIUM)
  status              ServiceTicketStatus @default(OPEN)
  
  assignedTechnicianId String?
  assignedTechnician   Employee? @relation(fields: [assignedTechnicianId], references: [id])
  
  scheduledDate       DateTime?
  estimatedHours      Decimal? @db.Decimal(6, 2)
  
  location            String?
  equipmentInfo       String?
  resolution          String?
  
  tags                String[] @default([])
  
  resolvedAt          DateTime?
  closedAt            DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  reports             ServiceReport[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@map("service_tickets")
}

model ServiceReport {
  id                String   @id @default(cuid())
  serviceTicketId   String
  serviceTicket     ServiceTicket @relation(fields: [serviceTicketId], references: [id], onDelete: Cascade)
  
  serviceDate       DateTime
  hoursWorked       Decimal  @db.Decimal(6, 2)
  travelTime        Decimal  @default(0) @db.Decimal(6, 2)
  
  workPerformed     String
  partsUsed         String?
  
  materialCost      Decimal  @default(0) @db.Decimal(12, 2)
  laborCost         Decimal  @default(0) @db.Decimal(12, 2)
  totalCost         Decimal  @default(0) @db.Decimal(12, 2)
  
  customerSignature String?
  photoUrls         String[] @default([])
  followUpNeeded    String?
  
  createdAt         DateTime @default(now())
  
  @@index([serviceTicketId])
  @@map("service_reports")
}
