// Loomora ERP - Complete Database Schema
// Swiss-compliant ERP with QR-Rechnung, HR, Projects, and more

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
  READONLY
}

enum DocumentStatus {
  DRAFT
  SENT
  CONFIRMED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CREDIT_CARD
  TWINT
  PAYPAL
  CASH
  INVOICE
}

enum VatRate {
  STANDARD    // 8.1%
  REDUCED     // 2.6%
  SPECIAL     // 3.8%
  EXEMPT      // 0%
}

enum ReminderLevel {
  FIRST
  SECOND
  THIRD
  FOURTH
  FIFTH
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum ProjectPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum EmployeeStatus {
  ACTIVE
  VACATION
  SICK
  INACTIVE
}

enum AbsenceType {
  VACATION
  SICK
  UNPAID
  MATERNITY
  PATERNITY
  OTHER
}

enum AbsenceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventType {
  MEETING
  CALL
  DEADLINE
  REMINDER
  VACATION
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

// Multi-Tenant & Subscription Enums
enum UserStatus {
  PENDING           // E-Mail nicht bestätigt
  ACTIVE            // Aktiver User
  SUSPENDED         // Gesperrt
  DELETED           // Gelöscht (soft delete)
}

enum CompanyStatus {
  PENDING_PAYMENT   // Warten auf erste Zahlung
  ACTIVE            // Aktiv mit gültiger Subscription
  SUSPENDED         // Gesperrt (Zahlung fehlgeschlagen)
  CANCELLED         // Gekündigt
}

enum SubscriptionStatus {
  PENDING           // Checkout initiiert, noch nicht bezahlt
  ACTIVE            // Aktive Subscription
  PAST_DUE          // Zahlung fehlgeschlagen (Grace Period)
  CANCELLED         // Gekündigt (läuft bis Periodenende)
  EXPIRED           // Abgelaufen
}

enum InvitationStatus {
  PENDING           // Einladung versendet
  ACCEPTED          // Angenommen
  EXPIRED           // Abgelaufen
  REVOKED           // Widerrufen
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// ============================================
// CORE / SYSTEM
// ============================================

model Company {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique  // URL-freundlicher Name
  legalName     String?
  street        String?
  zipCode       String?
  city          String?
  country       String        @default("CH")
  phone         String?
  email         String?
  website       String?
  vatNumber     String?       // CHE-123.456.789
  iban          String?
  bic           String?
  bankName      String?
  description   String?
  logoUrl       String?
  qrIban        String?       // Swiss QR-IBAN für QR-Rechnungen
  defaultCurrency String     @default("CHF")
  fiscalYearStart Int        @default(1)  // Monat 1-12
  
  // Multi-Tenant Status
  status        CompanyStatus @default(PENDING_PAYMENT)
  createdById   String?       // User der die Company erstellt hat
  
  // Settings as JSON
  settings      Json          @default("{}")
  shopSettings  Json?         // E-Commerce settings
  
  // Numbering (current counters)
  invoiceCounter    Int       @default(0)
  quoteCounter      Int       @default(0)
  orderCounter      Int       @default(0)
  deliveryCounter   Int       @default(0)
  creditNoteCounter Int       @default(0)
  purchaseCounter   Int       @default(0)
  projectCounter    Int       @default(0)
  employeeCounter   Int       @default(0)
  taskCounter       Int       @default(0)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  // Multi-Tenant Relations
  memberships   UserCompanyMembership[]
  roles         Role[]
  subscriptions Subscription[]
  invitations   Invitation[]
  
  // Business Relations (Legacy - User relation wird beibehalten für Migration)
  users         User[]
  customers     Customer[]
  suppliers     Supplier[]
  products      Product[]
  categories    ProductCategory[]
  quotes        Quote[]
  orders        Order[]
  invoices      Invoice[]
  creditNotes   CreditNote[]
  deliveryNotes DeliveryNote[]
  purchaseOrders PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  payments      Payment[]
  bankAccounts  BankAccount[]
  chartOfAccounts ChartOfAccount[]
  journalEntries JournalEntry[]
  projects      Project[]
  employees     Employee[]
  departments   Department[]
  timeEntries   TimeEntry[]
  calendarEvents CalendarEvent[]
  tasks         Task[]
  leads         Lead[]
  campaigns     Campaign[]
  
  teamMembers   CompanyTeamMember[]
  companySettings CompanySettings?
  notifications Notification[]
  payrollRuns   PayrollRun[]
  
  @@index([status])
  @@index([slug])
  @@map("companies")
}

model CompanyTeamMember {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  role        String
  avatarUrl   String?
  createdAt   DateTime @default(now())

  @@index([companyId])
  @@map("company_team_members")
}

model CompanySettings {
  id          String   @id @default(cuid())
  companyId   String   @unique
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Lokalisierung
  language    String   @default("de")
  timezone    String   @default("Europe/Zurich")
  dateFormat  String   @default("DD.MM.YYYY")

  // Währung
  currency       String  @default("CHF")
  exchangeRates  Json?

  // E-Mail/SMTP
  smtpHost       String?
  smtpPort       Int?
  smtpUser       String?
  smtpPassword   String?
  smtpFrom       String?
  smtpFromName   String?
  smtpSsl        Boolean @default(true)
  smtpEncryption String? @default("TLS")

  // Dokumente / Nummernkreise
  invoicePrefix         String? @default("RE-")
  invoiceNextNumber     Int?    @default(1)
  quotePrefix           String? @default("AN-")
  quoteNextNumber       Int?    @default(1)
  orderPrefix           String? @default("AU-")
  orderNextNumber       Int?    @default(1)
  deliveryNotePrefix    String? @default("LS-")
  creditNotePrefix      String? @default("GS-")
  purchaseOrderPrefix   String? @default("BE-")
  customerPrefix        String? @default("KD-")
  customerNextNumber    Int?    @default(1)
  projectPrefix         String? @default("PRJ-")
  projectNextNumber     Int?    @default(1)

  // PDF-Optionen
  logoPosition          String? @default("top-left")
  pdfLogoPosition       String? @default("top-left")
  headerColor           String? @default("#1a1a2e")
  footerLeft            String?
  footerRight           String?
  pdfFooterText         String?
  pdfShowBankDetails    Boolean @default(true)
  pdfDefaultLanguage    String? @default("de")
  enableQrInvoice       Boolean @default(true)
  enablePdfA            Boolean @default(true)
  defaultPaymentTerms   Int?    @default(30)

  // Benachrichtigungen
  emailNotifications    Boolean @default(true)
  invoiceReminders      Boolean @default(true)
  projectUpdates        Boolean @default(true)
  notifyOnNewInvoice    Boolean @default(true)
  notifyOnPaymentReceived Boolean @default(true)
  notifyOnContractExpiring Boolean @default(true)
  notifyDaysBeforeExpiry  Int?    @default(30)

  // API
  apiKeyHash            String?

  // Sicherheit
  twoFactorEnabled    Boolean @default(false)
  sessionTimeoutMin   Int     @default(480)
  passwordMinLength   Int     @default(8)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_settings")
}

// ============================================
// MULTI-TENANT: SUBSCRIPTION PLANS
// ============================================

model SubscriptionPlan {
  id              String   @id @default(cuid())
  name            String   // Basic, Pro, Enterprise
  description     String?
  
  priceMonthly    Decimal  @db.Decimal(10, 2)
  priceYearly     Decimal  @db.Decimal(10, 2)
  currency        String   @default("CHF")
  
  // Features & Limits as JSON
  features        Json     @default("{}")   // {"api_access": true, "exports": true}
  limits          Json     @default("{}")   // {"max_users": 5, "max_projects": 10}
  
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false)  // Standard-Plan bei Registrierung
  
  // Zahls.ch IDs (später zu befüllen)
  externalProductId String?   // Zahls.ch Product ID
  externalPriceIdMonthly String?  // Zahls.ch Price ID Monthly
  externalPriceIdYearly String?   // Zahls.ch Price ID Yearly
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  subscriptions   Subscription[]
  
  @@map("subscription_plans")
}

model Subscription {
  id                    String             @id @default(cuid())
  
  companyId             String
  company               Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  planId                String
  plan                  SubscriptionPlan   @relation(fields: [planId], references: [id])
  
  status                SubscriptionStatus @default(PENDING)
  billingCycle          BillingCycle       @default(MONTHLY)
  
  // Perioden
  currentPeriodStart    DateTime?
  currentPeriodEnd      DateTime?
  cancelledAt           DateTime?
  cancelAtPeriodEnd     Boolean            @default(false)
  
  // Zahls.ch IDs (später zu befüllen)
  externalSubscriptionId String?   // Zahls.ch Subscription ID
  externalCustomerId     String?   // Zahls.ch Customer ID
  
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  
  @@index([companyId])
  @@index([status])
  @@index([externalSubscriptionId])
  @@map("subscriptions")
}

// ============================================
// MULTI-TENANT: ROLES & PERMISSIONS
// ============================================

model Role {
  id            String   @id @default(cuid())
  
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name          String   // Owner, Admin, Manager, Member, Custom...
  description   String?
  isSystemRole  Boolean  @default(false)  // System-Rollen können nicht gelöscht werden
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  permissions   RolePermission[]
  memberships   UserCompanyMembership[]
  invitations   Invitation[]
  
  @@unique([companyId, name])
  @@index([companyId])
  @@map("roles")
}

model RolePermission {
  id          String   @id @default(cuid())
  
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  module      String   // customers, invoices, projects, settings, users...
  permission  String   // read, write, delete, admin
  
  createdAt   DateTime @default(now())
  
  @@unique([roleId, module, permission])
  @@index([roleId])
  @@map("role_permissions")
}

// ============================================
// MULTI-TENANT: USER-COMPANY MEMBERSHIP
// ============================================

model UserCompanyMembership {
  id          String   @id @default(cuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id])
  
  isOwner     Boolean  @default(false)  // Company-Eigentümer
  isPrimary   Boolean  @default(false)  // Primäre Company beim Login
  
  invitedById String?  // User der eingeladen hat
  
  joinedAt    DateTime @default(now())
  
  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@index([roleId])
  @@map("user_company_memberships")
}

// ============================================
// MULTI-TENANT: INVITATIONS
// ============================================

model Invitation {
  id          String           @id @default(cuid())
  
  companyId   String
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  email       String
  roleId      String
  role        Role             @relation(fields: [roleId], references: [id])
  
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  
  invitedById String           // User der eingeladen hat
  
  expiresAt   DateTime
  acceptedAt  DateTime?
  
  createdAt   DateTime         @default(now())
  
  @@index([companyId])
  @@index([email])
  @@index([token])
  @@map("invitations")
}

// ============================================
// MULTI-TENANT: REFRESH TOKENS
// ============================================

model RefreshToken {
  id          String   @id @default(cuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tokenHash   String   @unique
  
  // Device/Session Info
  deviceInfo  String?
  ipAddress   String?
  userAgent   String?
  
  expiresAt   DateTime
  revokedAt   DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// MULTI-TENANT: WEBHOOK EVENTS (Idempotenz)
// ============================================

model WebhookEvent {
  id              String   @id @default(cuid())
  
  externalEventId String   @unique  // Event-ID von Zahls.ch
  eventType       String             // checkout.session.completed, invoice.paid, etc.
  
  payload         Json               // Vollständiger Webhook-Payload
  
  status          String   @default("pending")  // pending, processed, failed
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([externalEventId])
  @@index([eventType])
  @@index([status])
  @@map("webhook_events")
}

// ============================================
// USERS (Updated for Multi-Tenant)
// ============================================

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  avatarUrl     String?
  
  // Multi-Tenant Status
  status        UserStatus @default(PENDING)
  
  // Legacy fields (für Rückwärtskompatibilität)
  role          UserRole   @default(EMPLOYEE)
  isActive      Boolean    @default(true)
  
  twoFactorEnabled Boolean @default(false)
  lastLoginAt   DateTime?
  
  // Legacy: Direkte Company-Relation (wird durch Memberships ersetzt)
  companyId     String?
  company       Company?   @relation(fields: [companyId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Multi-Tenant Relations
  memberships   UserCompanyMembership[]
  refreshTokens RefreshToken[]
  
  // Business Relations
  createdQuotes     Quote[]    @relation("QuoteCreator")
  createdOrders     Order[]    @relation("OrderCreator")
  createdInvoices   Invoice[]  @relation("InvoiceCreator")
  assignedTasks     Task[]     @relation("TaskAssignee")
  createdTasks      Task[]     @relation("TaskCreator")
  timeEntries       TimeEntry[]
  createdProjects   Project[]  @relation("ProjectCreator")
  managedProjects   Project[]  @relation("ProjectManager")
  eventAttendances  EventAttendee[]
  assignedLeads     Lead[]     @relation("LeadAssignee")
  assignedContracts Contract[] @relation("ContractResponsible")
  conductedInterviews Interview[] @relation("Interviewer")
  
  // DMS relations
  createdFolders    Folder[]   @relation("FolderCreatedBy")
  uploadedDocuments DMSDocument[] @relation("DocumentUploadedBy")
  documentVersions  DMSDocumentVersion[] @relation("DocumentVersionCreatedBy")
  
  // Audit log relations
  auditLogs         AuditLog[] @relation("UserAuditLogs")
  
  // Chat relations
  chatMessages      ChatMessage[] @relation("ChatMessageAuthor")
  chatReactions     ChatReaction[] @relation("ChatReactions")
  chatMentions      ChatMention[] @relation("ChatMentions")
  
  // Task sub-feature relations
  taskComments      TaskComment[]    @relation("TaskCommentAuthor")
  taskAttachments   TaskAttachment[] @relation("TaskAttachmentUploader")
  
  // Notification relations
  notifications     Notification[]   @relation("UserNotifications")
  
  // Employee relation (optional link)
  employeeId        String?   @unique
  employee          Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  
  @@index([companyId])
  @@index([email])
  @@index([status])
  @@map("users")
}

model Setting {
  id        String   @id @default(cuid())
  companyId String
  key       String
  value     Json
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([companyId, key])
  @@map("settings")
}

// ============================================
// CRM / CONTACTS
// ============================================

model Customer {
  id              String   @id @default(cuid())
  number          String   // KD-0001
  name            String
  companyName     String?
  salutation      String?
  street          String?
  zipCode         String?
  city            String?
  country         String   @default("CH")
  phone           String?
  mobile          String?
  email           String?
  website         String?
  vatNumber       String?
  taxId           String?
  vatId           String?
  iban            String?
  
  // Payment terms
  paymentTermDays Int      @default(30)
  creditLimit     Decimal? @db.Decimal(12, 2)
  discount        Decimal  @default(0) @db.Decimal(5, 2)  // Default discount %
  
  notes           String?
  isActive        Boolean  @default(true)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contacts        Contact[]
  quotes          Quote[]
  orders          Order[]
  invoices        Invoice[]
  creditNotes     CreditNote[]
  deliveryNotes   DeliveryNote[]
  payments        Payment[]
  projects        Project[]
  calculations    Calculation[]
  serviceTickets  ServiceTicket[]
  leads           Lead[]
  shopOrders      ShopOrder[]
  contracts       Contract[]
  
  // DMS relations
  folders         Folder[]      @relation("CustomerFolders")
  documents       DMSDocument[] @relation("CustomerDocuments")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([email])
  @@map("customers")
}

model Supplier {
  id              String   @id @default(cuid())
  number          String   // LF-0001
  name            String
  companyName     String?
  street          String?
  zipCode         String?
  city            String?
  country         String   @default("CH")
  phone           String?
  email           String?
  website         String?
  vatNumber       String?
  iban            String?
  
  paymentTermDays Int      @default(30)
  rating          Int?     @default(0)  // 0-5 stars
  notes           String?
  isActive        Boolean  @default(true)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contacts        Contact[]
  purchaseOrders  PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  products        Product[]
  payments        Payment[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("suppliers")
}

model Contact {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  position    String?
  phone       String?
  mobile      String?
  email       String?
  isPrimary   Boolean  @default(false)
  notes       String?
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  serviceTickets ServiceTicket[]
  
  @@index([customerId])
  @@index([supplierId])
  @@map("contacts")
}

model Lead {
  id              String     @id @default(cuid())
  name            String
  companyName     String?
  email           String?
  phone           String?
  position        String?
  source          String?    // WEBSITE, REFERRAL, COLD_CALL, TRADE_SHOW, SOCIAL_MEDIA, ADVERTISEMENT, OTHER
  status          LeadStatus @default(NEW)
  priority        String?    // LOW, MEDIUM, HIGH, URGENT
  estimatedValue  Decimal?   @db.Decimal(12, 2)
  score           Int?       @default(0)  // Lead scoring 0-100
  
  // Assignment
  assignedToId    String?
  assignedTo      User?      @relation("LeadAssignee", fields: [assignedToId], references: [id])
  
  // Campaign relation
  campaignId      String?
  campaign        Campaign?  @relation(fields: [campaignId], references: [id])
  
  // Conversion
  customerId      String?
  customer        Customer?  @relation(fields: [customerId], references: [id])
  convertedAt     DateTime?
  
  nextFollowUp    DateTime?
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  activities      LeadActivity[]
  
  @@index([companyId])
  @@index([status])
  @@index([assignedToId])
  @@index([campaignId])
  @@map("leads")
}

// ============================================
// PRODUCTS / INVENTORY
// ============================================

model ProductCategory {
  id          String   @id @default(cuid())
  name        String
  description String?
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@map("product_categories")
}

model Product {
  id              String   @id @default(cuid())
  sku             String   // ART-0001
  name            String
  description     String?
  
  unit            String   @default("Stk")  // Stk, kg, m, m², lfm, h
  
  purchasePrice   Decimal  @default(0) @db.Decimal(12, 2)
  salePrice       Decimal  @db.Decimal(12, 2)
  vatRate         VatRate  @default(STANDARD)
  
  // Inventory
  stockQuantity   Decimal  @default(0) @db.Decimal(12, 3)
  minStock        Decimal  @default(0) @db.Decimal(12, 3)
  maxStock        Decimal? @db.Decimal(12, 3)
  reservedStock   Decimal  @default(0) @db.Decimal(12, 3)
  
  // Dimensions (for shipping)
  weight          Decimal? @db.Decimal(10, 3)  // kg
  length          Decimal? @db.Decimal(10, 2)  // cm
  width           Decimal? @db.Decimal(10, 2)
  height          Decimal? @db.Decimal(10, 2)
  
  imageUrl        String?
  isActive        Boolean  @default(true)
  isService       Boolean  @default(false)
  
  categoryId      String?
  category        ProductCategory? @relation(fields: [categoryId], references: [id])
  
  supplierId      String?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  quoteItems      QuoteItem[]
  orderItems      OrderItem[]
  invoiceItems    InvoiceItem[]
  deliveryNoteItems DeliveryNoteItem[]
  creditNoteItems CreditNoteItem[]
  goodsReceiptItems GoodsReceiptItem[]
  inventoryMovements InventoryMovement[]
  bomItems        BomItem[]
  shopOrderItems  ShopOrderItem[]
  reviews         Review[]
  
  @@unique([companyId, sku])
  @@index([companyId])
  @@index([categoryId])
  @@map("products")
}

model InventoryMovement {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  type        String   // IN, OUT, ADJUSTMENT, RETURN
  quantity    Decimal  @db.Decimal(12, 3)
  reference   String?  // Order number, etc.
  notes       String?
  
  createdAt   DateTime @default(now())
  
  @@index([productId])
  @@map("inventory_movements")
}

// ============================================
// SALES: QUOTES
// ============================================

model Quote {
  id              String   @id @default(cuid())
  number          String   // AN-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  date            DateTime @default(now())
  validUntil      DateTime
  status          DocumentStatus @default(DRAFT)
  
  // Address (snapshot)
  billingAddress  Json?
  shippingAddress Json?
  
  // Totals
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  internalNotes   String?
  terms           String?
  
  createdById     String
  createdBy       User     @relation("QuoteCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           QuoteItem[]
  orders          Order[]  // Converted orders
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     VatRate  @default(STANDARD)
  total       Decimal  @db.Decimal(12, 2)
  
  @@index([quoteId])
  @@map("quote_items")
}

// ============================================
// SALES: ORDERS
// ============================================

model Order {
  id              String   @id @default(cuid())
  number          String   // AU-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  quoteId         String?
  quote           Quote?   @relation(fields: [quoteId], references: [id])
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  date            DateTime @default(now())
  deliveryDate    DateTime?
  status          DocumentStatus @default(DRAFT)
  
  billingAddress  Json?
  shippingAddress Json?
  
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  internalNotes   String?
  
  createdById     String
  createdBy       User     @relation("OrderCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           OrderItem[]
  invoices        Invoice[]
  deliveryNotes   DeliveryNote[]
  productionOrders ProductionOrder[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     VatRate  @default(STANDARD)
  total       Decimal  @db.Decimal(12, 2)
  
  // Delivery tracking
  deliveredQty Decimal @default(0) @db.Decimal(12, 3)
  
  @@index([orderId])
  @@map("order_items")
}

// ============================================
// SALES: DELIVERY NOTES
// ============================================

enum DeliveryNoteStatus {
  DRAFT
  SHIPPED
  DELIVERED
  CANCELLED
}

model DeliveryNote {
  id              String   @id @default(cuid())
  number          String   // LS-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  status          DeliveryNoteStatus @default(DRAFT)
  date            DateTime @default(now())
  deliveryDate    DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  deliveryAddress String?
  shippingAddress Json?
  trackingNumber  String?
  carrier         String?
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           DeliveryNoteItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("delivery_notes")
}

model DeliveryNoteItem {
  id              String   @id @default(cuid())
  deliveryNoteId  String
  deliveryNote    DeliveryNote @relation(fields: [deliveryNoteId], references: [id], onDelete: Cascade)
  
  position        Int
  productId       String?
  product         Product? @relation(fields: [productId], references: [id])
  description     String?
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  
  @@index([deliveryNoteId])
  @@index([productId])
  @@map("delivery_note_items")
}

// ============================================
// SALES: INVOICES
// ============================================

model Invoice {
  id              String   @id @default(cuid())
  number          String   // RE-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  date            DateTime @default(now())
  dueDate         DateTime
  paidAt          DateTime?
  status          InvoiceStatus @default(DRAFT)
  
  billingAddress  Json?
  
  subtotal        Decimal  @db.Decimal(12, 2)
  discountPercent Decimal? @db.Decimal(5, 2)
  discountAmount  Decimal? @db.Decimal(12, 2)
  vatRate         Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2)
  
  // Swiss QR-Rechnung
  qrReference     String?  // 26-digit reference
  qrIban          String?
  
  notes           String?
  internalNotes   String?
  paymentTerms    String?
  
  createdById     String
  createdBy       User     @relation("InvoiceCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           InvoiceItem[]
  payments        Payment[]
  reminders       Reminder[]
  creditNotes     CreditNote[]
  
  // DMS relations  
  documents       DMSDocument[] @relation("InvoiceDocuments")
  
  // Bank import relations
  matchedTransactions BankTransaction[] @relation("MatchedInvoice")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  position    Int
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  discount    Decimal? @db.Decimal(5, 2)
  vatRate     Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount   Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  
  @@index([invoiceId])
  @@map("invoice_items")
}

enum ReminderStatus {
  DRAFT
  SENT
  PAID
  CANCELLED
}

model Reminder {
  id          String   @id @default(cuid())
  number      String   // MHN-2024-0001
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  level       Int      @default(1)  // 1-5 (Swiss 5-level dunning)
  status      ReminderStatus @default(DRAFT)
  sentAt      DateTime?
  sendMethod  String?  // EMAIL, POST, BOTH
  dueDate     DateTime
  fee         Decimal  @default(0) @db.Decimal(10, 2)  // Mahngebühr
  totalWithFee Decimal @default(0) @db.Decimal(12, 2) // Original + fee
  notes       String?
  
  companyId   String
  
  createdAt   DateTime @default(now())
  
  @@unique([companyId, number])
  @@index([invoiceId])
  @@index([companyId])
  @@index([status])
  @@map("reminders")
}

// ============================================
// SALES: CREDIT NOTES
// ============================================

enum CreditNoteStatus {
  DRAFT
  ISSUED
  APPLIED
  CANCELLED
}

enum CreditNoteReason {
  RETURN
  PRICE_ADJUSTMENT
  QUANTITY_DIFFERENCE
  QUALITY_ISSUE
  GOODWILL
  OTHER
}

model CreditNote {
  id              String   @id @default(cuid())
  number          String   // GS-2024-0001
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])
  
  invoiceId       String?
  invoice         Invoice? @relation(fields: [invoiceId], references: [id])
  
  status          CreditNoteStatus @default(DRAFT)
  reason          CreditNoteReason?
  reasonText      String?
  issueDate       DateTime @default(now())
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatRate         Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           CreditNoteItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("credit_notes")
}

model CreditNoteItem {
  id            String   @id @default(cuid())
  creditNoteId  String
  creditNote    CreditNote @relation(fields: [creditNoteId], references: [id], onDelete: Cascade)
  
  position      Int
  productId     String?
  product       Product? @relation(fields: [productId], references: [id])
  description   String?
  quantity      Decimal  @db.Decimal(12, 3)
  unit          String
  unitPrice     Decimal  @db.Decimal(12, 2)
  vatRate       Decimal  @default(8.1) @db.Decimal(5, 2)
  vatAmount     Decimal  @db.Decimal(12, 2)
  total         Decimal  @db.Decimal(12, 2)
  
  @@index([creditNoteId])
  @@index([productId])
  @@map("credit_note_items")
}

// ============================================
// PURCHASING
// ============================================

model PurchaseOrder {
  id              String   @id @default(cuid())
  number          String   // BE-2024-0001
  
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  date            DateTime @default(now())
  expectedDate    DateTime?
  status          DocumentStatus @default(DRAFT)
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           PurchaseOrderItem[]
  purchaseInvoices PurchaseInvoice[]
  goodsReceipts   GoodsReceipt[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String   @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  position        Int
  description     String
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  unitPrice       Decimal  @db.Decimal(12, 2)
  vatRate         VatRate  @default(STANDARD)
  total           Decimal  @db.Decimal(12, 2)
  
  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model PurchaseInvoice {
  id              String   @id @default(cuid())
  number          String   // External invoice number
  
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  
  date            DateTime
  dueDate         DateTime
  status          InvoiceStatus @default(DRAFT)
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  totalAmount     Decimal  @db.Decimal(12, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2)
  
  documentUrl     String?  // Uploaded PDF
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  payments        Payment[]
  
  @@index([companyId])
  @@index([supplierId])
  @@map("purchase_invoices")
}

// ============================================
// PURCHASING: GOODS RECEIPTS
// ============================================

enum GoodsReceiptStatus {
  PENDING
  PARTIAL
  COMPLETE
  CANCELLED
}

enum QualityStatus {
  NOT_CHECKED
  PASSED
  FAILED
  PARTIAL
}

model GoodsReceipt {
  id                  String   @id @default(cuid())
  number              String   // WE-2024-0001
  
  purchaseOrderId     String
  purchaseOrder       PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  
  status              GoodsReceiptStatus @default(PENDING)
  receiptDate         DateTime @default(now())
  deliveryNoteNumber  String?
  carrier             String?
  notes               String?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  items               GoodsReceiptItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([purchaseOrderId])
  @@index([status])
  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id                String   @id @default(cuid())
  goodsReceiptId    String
  goodsReceipt      GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  
  position          Int
  productId         String
  product           Product  @relation(fields: [productId], references: [id])
  
  orderedQuantity   Decimal  @db.Decimal(12, 3)
  receivedQuantity  Decimal  @db.Decimal(12, 3)
  unit              String
  
  qualityStatus     QualityStatus @default(NOT_CHECKED)
  qualityNotes      String?
  batchNumber       String?
  serialNumber      String?
  storageLocation   String?
  
  @@index([goodsReceiptId])
  @@index([productId])
  @@map("goods_receipt_items")
}

// ============================================
// FINANCE: PAYMENTS
// ============================================

enum PaymentType {
  INCOMING  // Debitorenzahlung
  OUTGOING  // Kreditorenzahlung
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model Payment {
  id          String   @id @default(cuid())
  number      String   // ZE-2024-00001 or ZA-2024-00001
  
  type        PaymentType @default(INCOMING)
  status      PaymentStatus @default(PENDING)
  
  invoiceId   String?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  
  purchaseInvoiceId String?
  purchaseInvoice   PurchaseInvoice? @relation(fields: [purchaseInvoiceId], references: [id])
  
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  
  paymentDate DateTime @default(now())
  amount      Decimal  @db.Decimal(12, 2)
  method      String   // BANK_TRANSFER, CASH, etc.
  reference   String?  // Bank reference, transaction ID
  qrReference String?  // Swiss QR reference for matching
  notes       String?
  
  bankAccountId String?
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  // Bank import matching
  matchedBankTransactions BankTransaction[] @relation("MatchedPayment")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([invoiceId])
  @@index([purchaseInvoiceId])
  @@index([qrReference])
  @@index([status])
  @@map("payments")
}

// ============================================

// ============================================
// FINANCE: BANKING
// ============================================

model BankAccount {
  id          String   @id @default(cuid())
  name        String
  iban        String
  bic         String?
  bankName    String?
  currency    String   @default("CHF")
  balance     Decimal  @default(0) @db.Decimal(14, 2)
  isDefault   Boolean  @default(false)
  
  // For QR-Rechnung
  qrIban      String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  transactions BankTransaction[]
  payments    Payment[]
  
  @@index([companyId])
  @@map("bank_accounts")
}

// Old BankTransaction model removed - replaced by comprehensive camt.054 model at end of file

// ============================================
// FINANCE: ACCOUNTING
// ============================================

model ChartOfAccount {
  id          String   @id @default(cuid())
  number      String   // 4-digit: 1000, 1100, etc.
  name        String
  type        String   // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  parentId    String?
  parent      ChartOfAccount? @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    ChartOfAccount[] @relation("AccountHierarchy")
  
  isActive    Boolean  @default(true)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  debitEntries  JournalEntry[] @relation("DebitAccount")
  creditEntries JournalEntry[] @relation("CreditAccount")
  journalLines  JournalLine[] @relation("JournalLineAccount")
  budgetLines   BudgetLine[] @relation("BudgetLineAccount")
  cashTransactions CashTransaction[] @relation("CashTransactionAccount")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("chart_of_accounts")
}

model JournalEntry {
  id              String   @id @default(cuid())
  date            DateTime
  
  debitAccountId  String
  debitAccount    ChartOfAccount @relation("DebitAccount", fields: [debitAccountId], references: [id])
  
  creditAccountId String
  creditAccount   ChartOfAccount @relation("CreditAccount", fields: [creditAccountId], references: [id])
  
  amount          Decimal  @db.Decimal(14, 2)
  description     String?
  reference       String?  // Invoice number, etc.
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([companyId])
  @@index([date])
  @@map("journal_entries")
}

// ============================================
// PROJECTS
// ============================================

model Project {
  id              String   @id @default(cuid())
  number          String   // PRJ-2024-0001
  name            String
  description     String?
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  status          ProjectStatus @default(PLANNING)
  priority        ProjectPriority @default(MEDIUM)
  
  startDate       DateTime?
  endDate         DateTime?
  
  budget          Decimal? @db.Decimal(12, 2)
  spent           Decimal  @default(0) @db.Decimal(12, 2)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  
  progress        Int      @default(0)  // 0-100
  
  createdById     String
  createdBy       User     @relation("ProjectCreator", fields: [createdById], references: [id])
  
  managerId       String?
  manager         User?    @relation("ProjectManager", fields: [managerId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  tasks           Task[]
  timeEntries     TimeEntry[]
  orders          Order[]
  invoices        Invoice[]
  purchaseOrders  PurchaseOrder[]
  members         ProjectMember[]
  boms            BillOfMaterial[]
  productionOrders ProductionOrder[]
  calculations    Calculation[]
  serviceTickets  ServiceTicket[]
  contracts       Contract[]
  
  // DMS relations
  folders         Folder[]      @relation("ProjectFolders")
  documents       DMSDocument[] @relation("ProjectDocuments")
  
  // Chat relations
  chatMessages    ChatMessage[] @relation("ProjectChatMessages")
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  
  role      String?  // Developer, Designer, etc.
  
  createdAt DateTime @default(now())
  
  @@unique([projectId, employeeId])
  @@index([projectId])
  @@map("project_members")
}

// ============================================
// TASKS
// ============================================

model Task {
  id              String   @id @default(cuid())
  number          String?  @unique
  title           String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  status          TaskStatus @default(TODO)
  priority        TaskPriority @default(MEDIUM)
  
  dueDate         DateTime?
  estimatedHours  Decimal? @db.Decimal(6, 2)
  
  assigneeId      String?
  assignee        User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  
  createdById     String
  createdBy       User     @relation("TaskCreator", fields: [createdById], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  timeEntries     TimeEntry[]
  tags            TaskTag[]
  subtasks        Subtask[]
  comments        TaskComment[]
  attachments     TaskAttachment[]
  
  // Chat relations
  chatMessages    ChatMessage[] @relation("TaskChatMessages")
  
  @@index([companyId])
  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@map("tasks")
}

model TaskTag {
  id      String @id @default(cuid())
  taskId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  name    String
  
  @@index([taskId])
  @@map("task_tags")
}

model Subtask {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  title       String
  isCompleted Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
  @@map("subtasks")
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("TaskCommentAuthor", fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@map("task_comments")
}

model TaskAttachment {
  id           String   @id @default(cuid())
  taskId       String
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  fileName     String
  fileUrl      String
  fileSize     Int
  mimeType     String
  uploadedById String
  uploadedBy   User     @relation("TaskAttachmentUploader", fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())

  @@index([taskId])
  @@map("task_attachments")
}

// ============================================
// TIME TRACKING
// ============================================

model TimeEntry {
  id          String   @id @default(cuid())
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id])
  
  description String?
  date        DateTime @default(now())
  duration    Int      // in minutes
  
  isBillable  Boolean  @default(true)
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([companyId])
  @@index([userId])
  @@index([projectId])
  @@index([date])
  @@map("time_entries")
}

// ============================================
// CALENDAR
// ============================================

model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  
  type        EventType @default(MEETING)
  
  startTime   DateTime
  endTime     DateTime?
  isAllDay    Boolean  @default(false)
  
  location    String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attendees   EventAttendee[]
  reminders   EventReminder[]
  
  @@index([companyId])
  @@index([startTime])
  @@map("calendar_events")
}

model EventAttendee {
  id      String @id @default(cuid())
  eventId String
  event   CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  
  status  String @default("pending") // pending, accepted, declined
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@map("event_attendees")
}

model EventReminder {
  id          String   @id @default(cuid())
  eventId     String
  event       CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  minutesBefore Int
  method      String   // email, notification
  
  @@index([eventId])
  @@map("event_reminders")
}

// ============================================
// HR: EMPLOYEES
// ============================================

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  managerId   String?
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  employees   Employee[]
  
  @@index([companyId])
  @@map("departments")
}

model Employee {
  id              String   @id @default(cuid())
  number          String   // MA-0001
  
  firstName       String
  lastName        String
  email           String?
  phone           String?
  mobile          String?
  
  position        String?
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])
  
  status          EmployeeStatus @default(ACTIVE)
  
  hireDate        DateTime?
  terminationDate DateTime?
  
  // Swiss-specific
  ahvNumber       String?  // AHV-Nummer
  dateOfBirth     DateTime?
  nationality     String?
  maritalStatus   String?
  childrenCount   Int      @default(0)
  
  // Work details
  employmentType  String?  // Vollzeit, Teilzeit
  workloadPercent Int      @default(100)
  
  // Bank details
  iban            String?
  
  avatarUrl       String?
  notes           String?
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  contracts       EmployeeContract[]
  absences        Absence[]
  payslips        Payslip[]
  trainingParticipations TrainingParticipant[]
  trainingsInstructed Training[] @relation("TrainingInstructor")
  travelExpenses  TravelExpense[]
  projectMemberships ProjectMember[]
  productionOperations ProductionOperation[]
  qualityChecks   QualityCheck[]
  serviceTickets  ServiceTicket[]
  managedCostCenters CostCenter[]
  swissdecDeclarations SwissdecDeclaration[]
  gavData         GavEmployeeData?
  qstData         QstEmployeeData?
  jobContactPerson JobPosting[] @relation("JobContactPerson")
  
  // DMS relations
  documents       DMSDocument[] @relation("EmployeeDocuments")
  
  // User relation (optional link back)
  user            User?
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([departmentId])
  @@map("employees")
}

model EmployeeContract {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  contractType    String   // Unbefristet, Befristet, Temporär
  startDate       DateTime
  endDate         DateTime?
  
  // Salary (Swiss GAV Metallbau)
  salaryType      String   // Monatslohn, Stundenlohn
  baseSalary      Decimal  @db.Decimal(12, 2)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  
  // Swiss wage class (GAV Metallbau)
  wageClass       String?  // A, B, C, D, E, F
  
  workHoursPerWeek Decimal @default(42.5) @db.Decimal(4, 1)
  vacationDays    Int      @default(25)
  
  probationEnd    DateTime?
  noticePeriod    String?  // 1 Monat, 2 Monate, etc.
  
  thirteenthMonth Boolean  @default(false)
  workload        Decimal? @db.Decimal(5, 2)  // e.g. 100.00 for full time
  workLocation    String?
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@map("employee_contracts")
}

model Absence {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  type            AbsenceType
  status          AbsenceStatus @default(PENDING)
  
  startDate       DateTime
  endDate         DateTime
  
  days            Decimal  @db.Decimal(4, 1)  // Can be 0.5 for half days
  
  reason          String?
  notes           String?
  
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@index([startDate])
  @@map("absences")
}

// ============================================
// HR: PAYROLL
// ============================================

enum PayrollRunStatus {
  DRAFT
  PROCESSING
  COMPLETED
}

model PayrollRun {
  id              String   @id @default(cuid())
  period          String   // "2026-02"
  periodStart     DateTime
  periodEnd       DateTime
  status          PayrollRunStatus @default(DRAFT)
  employees       Int      @default(0)
  grossTotal      Decimal  @default(0) @db.Decimal(14, 2)
  netTotal        Decimal  @default(0) @db.Decimal(14, 2)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  payslips        Payslip[]
  
  @@unique([companyId, period])
  @@index([companyId])
  @@map("payroll_runs")
}

model Payslip {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Optional link to PayrollRun
  payrollRunId    String?
  payrollRun      PayrollRun? @relation(fields: [payrollRunId], references: [id])
  
  // Period (year/month for easier querying)
  year            Int
  month           Int
  period          DateTime? // Legacy field, optional
  
  // Calculated totals (computed from items)
  grossSalary     Decimal  @db.Decimal(12, 2)
  netSalary       Decimal  @db.Decimal(12, 2)
  totalDeductions Decimal  @default(0) @db.Decimal(12, 2)
  totalExpenses   Decimal  @default(0) @db.Decimal(12, 2)
  totalEmployerCost Decimal @default(0) @db.Decimal(12, 2)
  
  // Working time (matching Frontend workingTime object)
  targetHours     Decimal? @db.Decimal(6, 2)
  actualHours     Decimal? @db.Decimal(6, 2)
  overtimeHours   Decimal? @db.Decimal(6, 2)
  holidayDays     Decimal? @db.Decimal(4, 1)
  sickDays        Decimal? @db.Decimal(4, 1)
  vacationDays    Decimal? @db.Decimal(4, 1)
  
  // Payment info
  paymentDate     DateTime?
  status          PayslipStatus @default(DRAFT)
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations - ALL line items stored here (earnings, deductions, expenses, employer contributions)
  items           PayslipItem[]
  
  @@unique([employeeId, year, month])
  @@index([employeeId])
  @@index([year, month])
  @@index([payrollRunId])
  @@map("payslips")
}

enum PayslipStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
}

enum PayslipItemCategory {
  EARNING              // Bruttolohn-Positionen (base, overtime, allowance, family)
  DEDUCTION            // Abzüge (social, insurance, pension)
  EXPENSE              // Spesen (steuerfrei)
  EMPLOYER_CONTRIBUTION // Arbeitgeberbeiträge (nicht lohnwirksam)
}

model PayslipItem {
  id          String   @id @default(cuid())
  payslipId   String
  payslip     Payslip  @relation(fields: [payslipId], references: [id], onDelete: Cascade)
  
  category    PayslipItemCategory  // EARNING, DEDUCTION, EXPENSE, EMPLOYER_CONTRIBUTION
  type        String               // Subtype: base, overtime, social, insurance, pension, etc.
  description String
  amount      Decimal  @db.Decimal(12, 2)
  rate        Decimal? @db.Decimal(5, 2)  // Optional percentage rate (e.g., 5.3% for AHV)
  
  sortOrder   Int      @default(0)  // For display ordering
  
  @@index([payslipId])
  @@index([category])
  @@map("payslip_items")
}

// ============================================
// HR: TRAINING
// ============================================

model Training {
  id              String   @id @default(cuid())
  name            String
  description     String?
  
  type            String   // INTERNAL, EXTERNAL, ONLINE, WORKSHOP, CERTIFICATION, SAFETY, COMPLIANCE
  status          String   @default("DRAFT") // DRAFT, SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED
  
  startDate       DateTime
  endDate         DateTime?
  durationHours   Decimal? @db.Decimal(6, 2)
  
  location        String?
  isOnline        Boolean  @default(false)
  meetingUrl      String?
  
  maxParticipants Int?
  costPerPerson   Decimal? @db.Decimal(10, 2)
  totalBudget     Decimal? @db.Decimal(12, 2)
  
  provider        String?
  instructorId    String?
  instructor      Employee? @relation("TrainingInstructor", fields: [instructorId], references: [id])
  instructorName  String?
  
  targetDepartments String[] @default([])
  prerequisites   String[] @default([])
  certificationType String?
  isMandatory     Boolean  @default(false)
  
  notes           String?
  completedAt     DateTime?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  participants    TrainingParticipant[]
  
  @@index([companyId])
  @@index([status])
  @@map("trainings")
}

model TrainingParticipant {
  id                    String   @id @default(cuid())
  trainingId            String
  training              Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  
  employeeId            String
  employee              Employee @relation(fields: [employeeId], references: [id])
  
  status                String   @default("REGISTERED") // REGISTERED, CONFIRMED, ATTENDED, NO_SHOW, CANCELLED, WAITLIST
  attended              Boolean  @default(false)
  
  rating                Int?     // 1-5
  feedback              String?
  
  certificateIssued     Boolean  @default(false)
  certificateExpiryDate DateTime?
  
  notes                 String?
  
  createdAt             DateTime @default(now())
  
  @@unique([trainingId, employeeId])
  @@index([trainingId])
  @@index([status])
  @@map("training_participants")
}

// ============================================
// HR: TRAVEL EXPENSES
// ============================================

model TravelExpense {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  date            DateTime
  description     String
  
  // Swiss rates
  kilometers      Decimal? @db.Decimal(8, 2)
  kmRate          Decimal  @default(0.70) @db.Decimal(4, 2) // CHF 0.70/km
  
  mealAllowance   Decimal? @db.Decimal(10, 2)
  accommodation   Decimal? @db.Decimal(10, 2)
  otherExpenses   Decimal? @db.Decimal(10, 2)
  
  totalAmount     Decimal  @db.Decimal(12, 2)
  
  status          String   @default("pending") // pending, approved, rejected, paid
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  
  receiptUrl      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([employeeId])
  @@index([date])
  @@map("travel_expenses")
}

// ============================================
// MARKETING
// ============================================

model Campaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  
  type            String   // EMAIL, SOCIAL, PRINT, EVENT, DIGITAL, OTHER
  status          String   @default("DRAFT") // DRAFT, SCHEDULED, ACTIVE, PAUSED, COMPLETED, CANCELLED
  
  startDate       DateTime
  endDate         DateTime?
  
  budget          Decimal  @default(0) @db.Decimal(12, 2)
  spent           Decimal  @default(0) @db.Decimal(12, 2)
  
  targetAudience  String?
  expectedReach   Int?
  actualReach     Int?
  conversions     Int?     @default(0)
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  leads           Lead[]
  
  @@index([companyId])
  @@index([status])
  @@map("campaigns")
}

// AUDIT LOG - see end of file (model AuditLog with full Swiss OR compliance)

// ============================================
// PRODUCTION: BILL OF MATERIALS
// ============================================

model BillOfMaterial {
  id          String   @id @default(cuid())
  name        String
  description String?
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  isTemplate  Boolean  @default(false)
  category    String?  // Treppe, Geländer, Tor, etc.
  
  companyId   String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  items           BomItem[]
  productionOrders ProductionOrder[]
  calculations    Calculation[]
  
  @@index([companyId])
  @@index([projectId])
  @@map("bill_of_materials")
}

model BomItem {
  id          String   @id @default(cuid())
  bomId       String
  bom         BillOfMaterial @relation(fields: [bomId], references: [id], onDelete: Cascade)
  
  type        String   // MATERIAL, LABOR, EXTERNAL
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  description String
  quantity    Decimal  @db.Decimal(12, 3)
  unit        String
  unitPrice   Decimal  @db.Decimal(12, 2)
  
  hours       Decimal? @db.Decimal(10, 2)  // For labor items
  hourlyRate  Decimal? @db.Decimal(10, 2)
  
  total       Decimal  @db.Decimal(12, 2)
  sortOrder   Int      @default(0)
  
  @@index([bomId])
  @@index([productId])
  @@map("bom_items")
}

// ============================================
// PRODUCTION: PRODUCTION ORDERS
// ============================================

enum ProductionOrderStatus {
  PLANNED
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum ProductionPriority {
  HIGH
  MEDIUM
  LOW
}

model ProductionOrder {
  id              String   @id @default(cuid())
  number          String   // WA-2024-0001
  name            String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])
  
  bomId           String?
  bom             BillOfMaterial? @relation(fields: [bomId], references: [id])
  
  status          ProductionOrderStatus @default(PLANNED)
  priority        ProductionPriority @default(MEDIUM)
  
  quantity        Int      @default(1)
  
  plannedStartDate DateTime
  plannedEndDate   DateTime?
  actualStartDate  DateTime?
  actualEndDate    DateTime?
  
  notes           String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  operations      ProductionOperation[]
  qualityChecks   QualityCheck[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([projectId])
  @@index([status])
  @@map("production_orders")
}

model ProductionOperation {
  id                  String   @id @default(cuid())
  productionOrderId   String
  productionOrder     ProductionOrder @relation(fields: [productionOrderId], references: [id], onDelete: Cascade)
  
  name                String
  description         String?
  workstation         String?  // CNC, Schweissen, Montage, etc.
  
  plannedHours        Decimal  @db.Decimal(10, 2)
  actualHours         Decimal  @default(0) @db.Decimal(10, 2)
  
  assignedEmployeeId  String?
  assignedEmployee    Employee? @relation(fields: [assignedEmployeeId], references: [id])
  
  status              String   @default("pending")  // pending, in_progress, completed
  sortOrder           Int      @default(0)
  
  @@index([productionOrderId])
  @@index([assignedEmployeeId])
  @@map("production_operations")
}

// ============================================
// PRODUCTION: CALCULATIONS
// ============================================

enum CalculationStatus {
  DRAFT
  CALCULATED
  APPROVED
  TRANSFERRED
}

model Calculation {
  id              String   @id @default(cuid())
  number          String   // KA-2024-0001
  name            String
  description     String?
  
  projectId       String?
  project         Project? @relation(fields: [projectId], references: [id])
  
  bomId           String?
  bom             BillOfMaterial? @relation(fields: [bomId], references: [id])
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  quoteId         String?  // Link to created quote
  
  status          CalculationStatus @default(DRAFT)
  
  // Markup percentages (Swiss Metallbau defaults)
  materialMarkup  Decimal  @default(15) @db.Decimal(5, 2)
  laborMarkup     Decimal  @default(10) @db.Decimal(5, 2)
  overheadPercent Decimal  @default(8) @db.Decimal(5, 2)
  profitMargin    Decimal  @default(12) @db.Decimal(5, 2)
  riskMargin      Decimal  @default(5) @db.Decimal(5, 2)
  discount        Decimal  @default(0) @db.Decimal(5, 2)
  
  totalCost       Decimal? @db.Decimal(12, 2)
  totalPrice      Decimal? @db.Decimal(12, 2)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           CalculationItem[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([projectId])
  @@index([customerId])
  @@map("calculations")
}

model CalculationItem {
  id              String   @id @default(cuid())
  calculationId   String
  calculation     Calculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  
  type            String   // MATERIAL, LABOR, EXTERNAL, OVERHEAD
  productId       String?
  description     String
  quantity        Decimal  @db.Decimal(12, 3)
  unit            String
  unitCost        Decimal  @db.Decimal(12, 2)
  
  hours           Decimal? @db.Decimal(10, 2)
  hourlyRate      Decimal? @db.Decimal(10, 2)
  
  total           Decimal  @db.Decimal(12, 2)
  sortOrder       Int      @default(0)
  
  @@index([calculationId])
  @@map("calculation_items")
}

// ============================================
// QUALITY CONTROL
// ============================================

enum QualityCheckType {
  INCOMING
  IN_PROCESS
  FINAL
}

enum QualityCheckStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  CONDITIONAL
}

model QualityChecklist {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("FINAL")  // INCOMING, IN_PROCESS, FINAL
  category    String?  // Schweissnaht, Massgenauigkeit, Oberfläche
  
  companyId   String
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  items       ChecklistItem[]
  checks      QualityCheck[]
  
  @@index([companyId])
  @@map("quality_checklists")
}

model ChecklistItem {
  id          String   @id @default(cuid())
  checklistId String
  checklist   QualityChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  required    Boolean  @default(true)
  sortOrder   Int      @default(0)
  
  // Relations
  results     CheckResult[]
  
  @@index([checklistId])
  @@map("checklist_items")
}

model QualityCheck {
  id                  String   @id @default(cuid())
  number              String   // QC-2024-0001
  
  checklistId         String
  checklist           QualityChecklist @relation(fields: [checklistId], references: [id])
  
  productionOrderId   String?
  productionOrder     ProductionOrder? @relation(fields: [productionOrderId], references: [id])
  
  goodsReceiptId      String?
  
  type                String   // INCOMING, IN_PROCESS, FINAL
  status              String   @default("PENDING")
  
  inspectorId         String?
  inspector           Employee? @relation(fields: [inspectorId], references: [id])
  
  notes               String?
  completedAt         DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  results             CheckResult[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([checklistId])
  @@index([productionOrderId])
  @@index([status])
  @@map("quality_checks")
}

model CheckResult {
  id              String   @id @default(cuid())
  qualityCheckId  String
  qualityCheck    QualityCheck @relation(fields: [qualityCheckId], references: [id], onDelete: Cascade)
  
  checklistItemId String
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id])
  
  passed          Boolean
  notes           String?
  measuredValue   String?
  photoUrls       String[] @default([])
  
  createdAt       DateTime @default(now())
  
  @@unique([qualityCheckId, checklistItemId])
  @@index([qualityCheckId])
  @@map("check_results")
}

// ============================================
// SERVICE TICKETS
// ============================================

enum ServiceTicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

enum ServiceTicketPriority {
  URGENT
  HIGH
  MEDIUM
  LOW
}

enum ServiceType {
  REPAIR
  MAINTENANCE
  INSTALLATION
  INSPECTION
  WARRANTY
}

model ServiceTicket {
  id                  String   @id @default(cuid())
  number              String   // ST-2024-0001
  title               String
  description         String
  
  customerId          String
  customer            Customer @relation(fields: [customerId], references: [id])
  
  contactId           String?
  contact             Contact? @relation(fields: [contactId], references: [id])
  
  projectId           String?
  project             Project? @relation(fields: [projectId], references: [id])
  
  serviceType         ServiceType
  priority            ServiceTicketPriority @default(MEDIUM)
  status              ServiceTicketStatus @default(OPEN)
  
  assignedTechnicianId String?
  assignedTechnician   Employee? @relation(fields: [assignedTechnicianId], references: [id])
  
  scheduledDate       DateTime?
  estimatedHours      Decimal? @db.Decimal(6, 2)
  
  location            String?
  equipmentInfo       String?
  resolution          String?
  
  tags                String[] @default([])
  
  resolvedAt          DateTime?
  closedAt            DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  reports             ServiceReport[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@map("service_tickets")
}

model ServiceReport {
  id                String   @id @default(cuid())
  serviceTicketId   String
  serviceTicket     ServiceTicket @relation(fields: [serviceTicketId], references: [id], onDelete: Cascade)
  
  serviceDate       DateTime
  hoursWorked       Decimal  @db.Decimal(6, 2)
  travelTime        Decimal  @default(0) @db.Decimal(6, 2)
  
  workPerformed     String
  partsUsed         String?
  
  materialCost      Decimal  @default(0) @db.Decimal(12, 2)
  laborCost         Decimal  @default(0) @db.Decimal(12, 2)
  totalCost         Decimal  @default(0) @db.Decimal(12, 2)
  
  customerSignature String?
  photoUrls         String[] @default([])
  followUpNeeded    String?
  
  createdAt         DateTime @default(now())
  
  @@index([serviceTicketId])
  @@map("service_reports")
}

// ============================================
// EXTENDED ACCOUNTING: JOURNAL ENTRIES
// ============================================

enum JournalEntryStatus {
  DRAFT
  POSTED
  REVERSED
}

model JournalEntryExtended {
  id              String   @id @default(cuid())
  number          String   // JB-2024-00001
  date            DateTime
  description     String
  reference       String?  // Invoice number, etc.
  documentType    String?  // INVOICE, PAYMENT, MANUAL, etc.
  documentId      String?
  
  status          JournalEntryStatus @default(DRAFT)
  totalAmount     Decimal  @db.Decimal(14, 2)
  
  postedAt        DateTime?
  
  // Reversal tracking
  reversesEntryId String?
  reversesEntry   JournalEntryExtended? @relation("JournalReversal", fields: [reversesEntryId], references: [id])
  reversedBy      JournalEntryExtended[] @relation("JournalReversal")
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  lines           JournalLine[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([date])
  @@index([status])
  @@map("journal_entries_extended")
}

model JournalLine {
  id              String   @id @default(cuid())
  journalEntryId  String
  journalEntry    JournalEntryExtended @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  
  accountId       String
  account         ChartOfAccount @relation("JournalLineAccount", fields: [accountId], references: [id])
  
  debit           Decimal  @default(0) @db.Decimal(14, 2)
  credit          Decimal  @default(0) @db.Decimal(14, 2)
  
  costCenterId    String?
  costCenter      CostCenter? @relation(fields: [costCenterId], references: [id])
  
  description     String?
  sortOrder       Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([journalEntryId])
  @@index([accountId])
  @@index([costCenterId])
  @@map("journal_lines")
}

// ============================================
// EXTENDED ACCOUNTING: COST CENTERS
// ============================================

model CostCenter {
  id              String   @id @default(cuid())
  number          String   // 100, 200, etc.
  name            String
  description     String?
  
  parentId        String?
  parent          CostCenter? @relation("CostCenterHierarchy", fields: [parentId], references: [id])
  children        CostCenter[] @relation("CostCenterHierarchy")
  
  managerId       String?
  manager         Employee? @relation(fields: [managerId], references: [id])
  
  budgetAmount    Decimal? @db.Decimal(14, 2)
  isActive        Boolean  @default(true)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  journalLines    JournalLine[]
  budgetLines     BudgetLine[]
  cashTransactions CashTransaction[]
  fixedAssets     FixedAsset[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@map("cost_centers")
}

// ============================================
// EXTENDED ACCOUNTING: BUDGETS
// ============================================

enum BudgetStatus {
  DRAFT
  APPROVED
  ACTIVE
  CLOSED
}

enum BudgetPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

model Budget {
  id              String   @id @default(cuid())
  number          String   // BUD-2024-001
  name            String
  description     String?
  
  period          BudgetPeriod
  year            Int
  quarter         Int?     // 1-4 for quarterly
  month           Int?     // 1-12 for monthly
  
  status          BudgetStatus @default(DRAFT)
  totalAmount     Decimal  @default(0) @db.Decimal(14, 2)
  
  approvedAt      DateTime?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  lines           BudgetLine[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([year])
  @@index([status])
  @@map("budgets")
}

model BudgetLine {
  id              String   @id @default(cuid())
  budgetId        String
  budget          Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  
  accountId       String
  account         ChartOfAccount @relation("BudgetLineAccount", fields: [accountId], references: [id])
  
  costCenterId    String?
  costCenter      CostCenter? @relation(fields: [costCenterId], references: [id])
  
  amount          Decimal  @db.Decimal(14, 2)
  notes           String?
  
  createdAt       DateTime @default(now())
  
  @@index([budgetId])
  @@index([accountId])
  @@map("budget_lines")
}

// ============================================
// EXTENDED ACCOUNTING: CASH BOOK
// ============================================

enum CashTransactionType {
  RECEIPT
  PAYMENT
  OPENING
  CLOSING
}

model CashRegister {
  id              String   @id @default(cuid())
  name            String
  location        String?
  currentBalance  Decimal  @default(0) @db.Decimal(14, 2)
  isDefault       Boolean  @default(false)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  transactions    CashTransaction[]
  closings        CashClosing[]
  
  @@index([companyId])
  @@map("cash_registers")
}

model CashTransaction {
  id              String   @id @default(cuid())
  number          String   // KB-2024-00001
  
  cashRegisterId  String
  cashRegister    CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  
  date            DateTime
  type            CashTransactionType
  amount          Decimal  @db.Decimal(14, 2)
  description     String
  reference       String?
  category        String?
  
  accountId       String?
  account         ChartOfAccount? @relation("CashTransactionAccount", fields: [accountId], references: [id])
  
  costCenterId    String?
  costCenter      CostCenter? @relation(fields: [costCenterId], references: [id])
  
  vatRate         String?
  vatAmount       Decimal  @default(0) @db.Decimal(14, 2)
  
  balanceAfter    Decimal  @db.Decimal(14, 2)
  isPosted        Boolean  @default(false)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([cashRegisterId])
  @@index([date])
  @@map("cash_transactions")
}

model CashClosing {
  id              String   @id @default(cuid())
  
  cashRegisterId  String
  cashRegister    CashRegister @relation(fields: [cashRegisterId], references: [id], onDelete: Cascade)
  
  date            DateTime
  systemBalance   Decimal  @db.Decimal(14, 2)
  countedAmount   Decimal  @db.Decimal(14, 2)
  difference      Decimal  @db.Decimal(14, 2)
  notes           String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  
  @@index([cashRegisterId])
  @@index([date])
  @@map("cash_closings")
}

// ============================================
// EXTENDED ACCOUNTING: VAT RETURNS
// ============================================

enum VatReturnStatus {
  DRAFT
  CALCULATED
  SUBMITTED
  ACCEPTED
  REJECTED
}

enum VatReturnPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum VatMethod {
  AGREED
  RECEIVED
}

model VatReturn {
  id                  String   @id @default(cuid())
  number              String   // MWST-2024-Q1
  
  year                Int
  period              VatReturnPeriod
  quarter             Int?     // 1-4
  month               Int?     // 1-12
  method              VatMethod @default(AGREED)
  
  status              VatReturnStatus @default(DRAFT)
  
  data                Json     @default("{}")  // Form 050 fields
  
  totalOutputTax      Decimal? @db.Decimal(14, 2)
  totalInputTax       Decimal? @db.Decimal(14, 2)
  vatPayable          Decimal? @db.Decimal(14, 2)
  
  calculatedAt        DateTime?
  submittedAt         DateTime?
  submissionMethod    String?
  submissionReference String?
  notes               String?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([companyId, year, period, quarter, month])
  @@index([companyId])
  @@index([year])
  @@index([status])
  @@map("vat_returns")
}

// ============================================
// EXTENDED ACCOUNTING: FIXED ASSETS
// ============================================

enum AssetCategory {
  BUILDINGS
  MACHINERY
  VEHICLES
  FURNITURE
  IT_EQUIPMENT
  SOFTWARE
  TOOLS
  OTHER
}

enum DepreciationMethod {
  LINEAR
  DECLINING
}

enum AssetStatus {
  ACTIVE
  FULLY_DEPRECIATED
  DISPOSED
  SOLD
}

model FixedAsset {
  id                  String   @id @default(cuid())
  number              String   // ANL-00001
  name                String
  description         String?
  
  category            AssetCategory
  serialNumber        String?
  location            String?
  
  acquisitionDate     DateTime
  acquisitionCost     Decimal  @db.Decimal(14, 2)
  residualValue       Decimal  @default(0) @db.Decimal(14, 2)
  currentBookValue    Decimal  @db.Decimal(14, 2)
  
  usefulLife          Int      // Years
  depreciationMethod  DepreciationMethod
  depreciationRate    Decimal  @db.Decimal(5, 4)  // e.g., 0.125 for 12.5%
  
  status              AssetStatus @default(ACTIVE)
  
  // Disposal info
  disposalDate        DateTime?
  salePrice           Decimal? @db.Decimal(14, 2)
  gainLoss            Decimal? @db.Decimal(14, 2)
  disposalReason      String?
  disposalNotes       String?
  
  // Relations
  purchaseInvoiceId   String?
  costCenterId        String?
  costCenter          CostCenter? @relation(fields: [costCenterId], references: [id])
  
  assetAccountId      String?
  depreciationAccountId String?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  depreciations       AssetDepreciation[]
  
  @@unique([companyId, number])
  @@index([companyId])
  @@index([category])
  @@index([status])
  @@map("fixed_assets")
}

model AssetDepreciation {
  id              String   @id @default(cuid())
  
  fixedAssetId    String
  fixedAsset      FixedAsset @relation(fields: [fixedAssetId], references: [id], onDelete: Cascade)
  
  year            Int
  amount          Decimal  @db.Decimal(14, 2)
  bookValueBefore Decimal  @db.Decimal(14, 2)
  bookValueAfter  Decimal  @db.Decimal(14, 2)
  
  journalEntryId  String?
  isPosted        Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  
  @@unique([fixedAssetId, year])
  @@index([fixedAssetId])
  @@map("asset_depreciations")
}

// ============================================
// HR: SWISSDEC / ELM
// ============================================

enum SwissdecMessageType {
  SALARY_DECLARATION
  ANNUAL_DECLARATION
  CORRECTION
  TERMINATION
}

enum SwissdecStatus {
  DRAFT
  VALIDATED
  SUBMITTED
  ACKNOWLEDGED
  REJECTED
  PROCESSED
}

model SwissdecSubmission {
  id              String   @id @default(cuid())
  reference       String   // ELM-2024-0001
  
  messageType     SwissdecMessageType
  year            Int
  month           Int?
  
  recipients      String[] @default([])  // AHV, FAK, UVG, etc.
  status          SwissdecStatus @default(DRAFT)
  
  employeeCount   Int      @default(0)
  
  validationErrors   String[] @default([])
  validationWarnings String[] @default([])
  validatedAt     DateTime?
  
  submittedAt     DateTime?
  transmissionId  String?
  xmlContent      String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  declarations    SwissdecDeclaration[]
  
  @@unique([companyId, reference])
  @@index([companyId])
  @@index([year])
  @@index([status])
  @@map("swissdec_submissions")
}

model SwissdecDeclaration {
  id              String   @id @default(cuid())
  
  submissionId    String
  submission      SwissdecSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  year            Int
  month           Int?
  
  data            Json     @default("{}")  // Salary declaration data
  
  createdAt       DateTime @default(now())
  
  @@index([submissionId])
  @@index([employeeId])
  @@map("swissdec_declarations")
}

// ============================================
// HR: GAV METALLBAU
// ============================================

enum GavLohnklasse {
  A   // Ungelernte
  B   // Angelernte
  C   // EFZ
  D   // EFZ + Zusatz
  E   // Vorarbeiter
  F   // Meister
}

model GavSettings {
  id              String   @id @default(cuid())
  
  year            Int
  weeklyHours     Decimal  @default(42.5) @db.Decimal(4, 1)
  
  minRateA        Decimal  @db.Decimal(6, 2)
  minRateB        Decimal  @db.Decimal(6, 2)
  minRateC        Decimal  @db.Decimal(6, 2)
  minRateD        Decimal  @db.Decimal(6, 2)
  minRateE        Decimal  @db.Decimal(6, 2)
  minRateF        Decimal  @db.Decimal(6, 2)
  
  schmutzzulage   Decimal  @db.Decimal(6, 2)
  hoehenzulage    Decimal  @db.Decimal(6, 2)
  nachtzulageProzent Int
  sonntagProzent  Int
  ueberZeitProzent Int
  essenszulage    Decimal  @db.Decimal(6, 2)
  unterkunftMax   Decimal  @db.Decimal(6, 2)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([companyId, year])
  @@index([companyId])
  @@map("gav_settings")
}

model GavEmployeeData {
  id              String   @id @default(cuid())
  
  employeeId      String   @unique
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  lohnklasse      GavLohnklasse
  hourlyRate      Decimal  @db.Decimal(8, 2)
  
  yearsExperience Int?
  hasEfz          Boolean  @default(false)
  efzProfession   String?
  efzDate         DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([lohnklasse])
  @@map("gav_employee_data")
}

// ============================================
// HR: WITHHOLDING TAX (QUELLENSTEUER)
// ============================================

enum QstStatus {
  ACTIVE
  EXEMPT
  CROSS_BORDER
}

model QstEmployeeData {
  id              String   @id @default(cuid())
  
  employeeId      String   @unique
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  status          QstStatus @default(ACTIVE)
  kanton          String    // ZH, BE, GE, etc.
  tarif           String    // A, B, C, etc.
  childCount      Decimal   @default(0) @db.Decimal(3, 1)  // 0.0, 0.5, 1.0, etc.
  
  churchMember    Boolean   @default(true)
  nationality     String?
  permitType      String?   // B, L, G, etc.
  permitValidUntil DateTime?
  crossBorderCountry String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([kanton])
  @@index([status])
  @@map("qst_employee_data")
}

// ============================================
// MARKETING: LEAD ACTIVITIES
// ============================================

model LeadActivity {
  id              String   @id @default(cuid())
  
  leadId          String
  lead            Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  type            String   // CALL, EMAIL, MEETING, NOTE, TASK
  description     String
  activityDate    DateTime @default(now())
  durationMinutes Int?
  outcome         String?
  
  createdAt       DateTime @default(now())
  
  @@index([leadId])
  @@index([activityDate])
  @@map("lead_activities")
}

// ============================================
// MARKETING: EMAIL CAMPAIGNS
// ============================================

model EmailCampaign {
  id              String   @id @default(cuid())
  name            String
  subject         String
  content         String   @db.Text
  
  templateId      String?
  status          String   @default("DRAFT") // DRAFT, SCHEDULED, SENDING, SENT, CANCELLED
  
  scheduledAt     DateTime?
  sentAt          DateTime?
  
  recipientListIds String[] @default([])
  
  senderName      String?
  senderEmail     String?
  replyToEmail    String?
  
  // Stats
  sentCount       Int      @default(0)
  openCount       Int      @default(0)
  clickCount      Int      @default(0)
  bounceCount     Int      @default(0)
  unsubscribeCount Int     @default(0)
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
  @@index([status])
  @@map("email_campaigns")
}

// ============================================
// E-COMMERCE: SHOP ORDERS
// ============================================

model ShopOrder {
  id              String   @id @default(cuid())
  orderNumber     String   // WEB-00001
  
  customerId      String?
  customer        Customer? @relation(fields: [customerId], references: [id])
  
  customerEmail   String
  billingAddress  Json
  shippingAddress Json?
  
  status          String   @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED, REFUNDED
  paymentMethod   String?  // TWINT, CREDIT_CARD, PAYPAL, INVOICE, BANK_TRANSFER
  paymentStatus   String   @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  
  subtotal        Decimal  @db.Decimal(12, 2)
  discountAmount  Decimal  @default(0) @db.Decimal(12, 2)
  shippingCost    Decimal  @default(0) @db.Decimal(10, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  discountId      String?
  discount        Discount? @relation(fields: [discountId], references: [id])
  
  trackingNumber  String?
  trackingUrl     String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  cancelledAt     DateTime?
  
  notes           String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  items           ShopOrderItem[]
  reviews         Review[]
  
  @@unique([companyId, orderNumber])
  @@index([companyId])
  @@index([status])
  @@index([paymentStatus])
  @@map("shop_orders")
}

model ShopOrderItem {
  id              String   @id @default(cuid())
  
  shopOrderId     String
  shopOrder       ShopOrder @relation(fields: [shopOrderId], references: [id], onDelete: Cascade)
  
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  
  quantity        Int
  unitPrice       Decimal  @db.Decimal(12, 2)
  discount        Decimal  @default(0) @db.Decimal(10, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  @@index([shopOrderId])
  @@index([productId])
  @@map("shop_order_items")
}

// ============================================
// E-COMMERCE: DISCOUNTS
// ============================================

model Discount {
  id                  String   @id @default(cuid())
  code                String   // SUMMER2024
  name                String
  description         String?
  
  type                String   // PERCENTAGE, FIXED_AMOUNT, FREE_SHIPPING
  value               Decimal  @db.Decimal(10, 2)
  
  minimumOrderValue   Decimal? @db.Decimal(12, 2)
  maximumDiscount     Decimal? @db.Decimal(12, 2)
  
  usageLimit          Int?
  usageLimitPerCustomer Int?
  usageCount          Int      @default(0)
  
  validFrom           DateTime
  validUntil          DateTime?
  
  isActive            Boolean  @default(true)
  
  applicableProductIds String[] @default([])
  applicableCategoryIds String[] @default([])
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  shopOrders          ShopOrder[]
  
  @@unique([companyId, code])
  @@index([companyId])
  @@index([isActive])
  @@map("discounts")
}

// ============================================
// E-COMMERCE: REVIEWS
// ============================================

model Review {
  id                  String   @id @default(cuid())
  
  productId           String
  product             Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  shopOrderId         String?
  shopOrder           ShopOrder? @relation(fields: [shopOrderId], references: [id])
  
  customerName        String
  customerEmail       String?
  
  rating              Int      // 1-5
  title               String?
  content             String   @db.Text
  
  isVerifiedPurchase  Boolean  @default(false)
  status              String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  moderatorNote       String?
  moderatedAt         DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([productId])
  @@index([status])
  @@index([companyId])
  @@map("reviews")
}

// ============================================
// CONTRACTS
// ============================================

model Contract {
  id                  String   @id @default(cuid())
  contractNumber      String   // V-0001-2024
  name                String
  description         String?
  
  type                String   // SERVICE, MAINTENANCE, SUPPORT, LICENSE, FRAMEWORK, OTHER
  status              String   @default("DRAFT") // DRAFT, ACTIVE, SUSPENDED, TERMINATED, EXPIRED
  
  customerId          String
  customer            Customer @relation(fields: [customerId], references: [id])
  
  projectId           String?
  project             Project? @relation(fields: [projectId], references: [id])
  
  startDate           DateTime
  endDate             DateTime?
  durationMonths      Int?
  
  autoRenew           Boolean  @default(false)
  renewalPeriodMonths Int?
  noticePeriodDays    Int?
  renewalCount        Int      @default(0)
  
  value               Decimal  @db.Decimal(14, 2)
  billingCycle        String?  // MONTHLY, QUARTERLY, SEMI_ANNUAL, ANNUAL, ONE_TIME
  paymentTerms        String?
  
  terms               String?  @db.Text
  notes               String?
  
  responsibleId       String?
  responsible         User?    @relation("ContractResponsible", fields: [responsibleId], references: [id])
  
  terminatedAt        DateTime?
  terminationReason   String?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  renewalHistory      ContractRenewal[]
  
  // DMS relations
  documents           DMSDocument[] @relation("ContractDocuments")
  
  @@unique([companyId, contractNumber])
  @@index([companyId])
  @@index([customerId])
  @@index([status])
  @@map("contracts")
}

model ContractRenewal {
  id              String   @id @default(cuid())
  
  contractId      String
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  previousEndDate DateTime?
  newEndDate      DateTime
  
  previousValue   Decimal  @db.Decimal(14, 2)
  newValue        Decimal  @db.Decimal(14, 2)
  
  notes           String?
  
  createdAt       DateTime @default(now())
  
  @@index([contractId])
  @@map("contract_renewals")
}

// ============================================
// RECRUITING: JOB POSTINGS
// ============================================

model JobPosting {
  id                  String   @id @default(cuid())
  title               String
  description         String   @db.Text
  requirements        String?  @db.Text
  benefits            String?  @db.Text
  
  department          String?
  location            String?
  remoteAllowed       Boolean  @default(false)
  
  employmentType      String   // FULL_TIME, PART_TIME, TEMPORARY, CONTRACT, INTERNSHIP, APPRENTICESHIP
  status              String   @default("DRAFT") // DRAFT, PUBLISHED, PAUSED, CLOSED, FILLED
  
  salaryMin           Decimal? @db.Decimal(12, 2)
  salaryMax           Decimal? @db.Decimal(12, 2)
  workloadPercent     Int?
  
  startDate           DateTime?
  applicationDeadline DateTime?
  publishedAt         DateTime?
  
  contactPersonId     String?
  contactPerson       Employee? @relation("JobContactPerson", fields: [contactPersonId], references: [id])
  
  requiredSkills      String[] @default([])
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  candidates          Candidate[]
  
  @@index([companyId])
  @@index([status])
  @@map("job_postings")
}

// ============================================
// RECRUITING: CANDIDATES
// ============================================

model Candidate {
  id                  String   @id @default(cuid())
  firstName           String
  lastName            String
  email               String
  phone               String?
  
  street              String?
  zipCode             String?
  city                String?
  country             String?
  
  dateOfBirth         DateTime?
  nationality         String?
  
  linkedinUrl         String?
  portfolioUrl        String?
  resumeUrl           String?
  coverLetterUrl      String?
  
  jobPostingId        String
  jobPosting          JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  
  status              String   @default("NEW") // NEW, SCREENING, INTERVIEW, ASSESSMENT, OFFER, HIRED, REJECTED, WITHDRAWN
  source              String?  // WEBSITE, JOB_PORTAL, LINKEDIN, REFERRAL, AGENCY, DIRECT, OTHER
  
  expectedSalary      Decimal? @db.Decimal(12, 2)
  availableFrom       DateTime?
  
  rating              Int?     // 1-5
  notes               String?  @db.Text
  skills              String[] @default([])
  
  hiredAt             DateTime?
  
  companyId           String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  interviews          Interview[]
  
  @@index([companyId])
  @@index([jobPostingId])
  @@index([status])
  @@map("candidates")
}

// ============================================
// RECRUITING: INTERVIEWS
// ============================================

model Interview {
  id              String   @id @default(cuid())
  
  candidateId     String
  candidate       Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  type            String   // PHONE, VIDEO, ONSITE, TECHNICAL, HR, FINAL
  status          String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  
  scheduledAt     DateTime
  durationMinutes Int?
  
  location        String?
  meetingUrl      String?
  
  feedback        String?  @db.Text
  rating          Int?     // 1-5
  recommendHire   Boolean?
  
  notes           String?
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  interviewers    User[]   @relation("Interviewer")
  
  @@index([candidateId])
  @@index([status])
  @@index([companyId])
  @@map("interviews")
}

// ============================================
// BANK IMPORT (camt.054)
// ============================================

enum BankTransactionType {
  CREDIT
  DEBIT
}

enum BankTransactionStatus {
  PENDING
  MATCHED
  RECONCILED
  IGNORED
}

model BankTransaction {
  id              String   @id @default(cuid())
  
  bankAccountId   String
  bankAccount     BankAccount @relation(fields: [bankAccountId], references: [id])
  
  entryReference  String?
  type            BankTransactionType
  amount          Decimal  @db.Decimal(12, 2)
  currency        String   @default("CHF")
  
  bookingDate     DateTime
  valueDate       DateTime
  
  qrReference     String?  // Swiss QR reference (26-27 digits)
  creditorReference String?
  endToEndId      String?
  remittanceInfo  String?  @db.Text
  
  debtorName      String?
  debtorIban      String?
  creditorName    String?
  creditorIban    String?
  
  status          BankTransactionStatus @default(PENDING)
  
  matchedInvoiceId String?
  matchedInvoice   Invoice? @relation("MatchedInvoice", fields: [matchedInvoiceId], references: [id])
  
  matchedPaymentId String?
  matchedPayment   Payment? @relation("MatchedPayment", fields: [matchedPaymentId], references: [id])
  
  companyId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([companyId])
  @@index([bankAccountId])
  @@index([qrReference])
  @@index([status])
  @@map("bank_transactions")
}

// ============================================
// DOCUMENT MANAGEMENT SYSTEM (DMS)
// ============================================

enum FolderType {
  SYSTEM
  PROJECT
  CUSTOMER
  INVOICE
  CONTRACT
  EMPLOYEE
  GENERAL
}

enum DMSDocumentStatus {
  ACTIVE
  ARCHIVED
  DELETED
}

model Folder {
  id          String   @id @default(cuid())
  name        String
  type        FolderType @default(GENERAL)
  description String?
  
  parentId    String?
  parent      Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id])
  children    Folder[] @relation("FolderHierarchy")
  
  projectId   String?
  project     Project? @relation("ProjectFolders", fields: [projectId], references: [id])
  
  customerId  String?
  customer    Customer? @relation("CustomerFolders", fields: [customerId], references: [id])
  
  companyId   String
  createdById String
  createdBy   User     @relation("FolderCreatedBy", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  documents   DMSDocument[]
  
  @@index([companyId])
  @@index([parentId])
  @@index([projectId])
  @@index([customerId])
  @@map("folders")
}

model DMSDocument {
  id          String   @id @default(cuid())
  name        String
  mimeType    String?
  fileSize    Int?
  storageUrl  String?
  storagePath String?
  description String?
  tags        String[] @default([])
  
  version     Int      @default(1)
  status      DMSDocumentStatus @default(ACTIVE)
  
  folderId    String?
  folder      Folder?  @relation(fields: [folderId], references: [id])
  
  projectId   String?
  project     Project? @relation("ProjectDocuments", fields: [projectId], references: [id])
  
  customerId  String?
  customer    Customer? @relation("CustomerDocuments", fields: [customerId], references: [id])
  
  invoiceId   String?
  invoice     Invoice? @relation("InvoiceDocuments", fields: [invoiceId], references: [id])
  
  contractId  String?
  contract    Contract? @relation("ContractDocuments", fields: [contractId], references: [id])
  
  employeeId  String?
  employee    Employee? @relation("EmployeeDocuments", fields: [employeeId], references: [id])
  
  companyId   String
  uploadedById String
  uploadedBy  User     @relation("DocumentUploadedBy", fields: [uploadedById], references: [id])
  
  // Sharing
  sharedWith      String[]  @default([])
  shareToken      String?   @unique
  sharePermission String?   @default("VIEW")
  shareExpiresAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  versions    DMSDocumentVersion[]
  
  @@index([companyId])
  @@index([folderId])
  @@index([status])
  @@map("dms_documents")
}

model DMSDocumentVersion {
  id          String   @id @default(cuid())
  documentId  String
  document    DMSDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  version     Int
  storageUrl  String
  storagePath String?
  fileSize    Int
  changeNote  String?
  
  createdById String
  createdBy   User     @relation("DocumentVersionCreatedBy", fields: [createdById], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@index([documentId])
  @@map("dms_document_versions")
}

// ============================================
// CHAT MESSAGES
// ============================================

model ChatMessage {
  id          String   @id @default(cuid())
  content     String
  
  authorId    String
  author      User     @relation("ChatMessageAuthor", fields: [authorId], references: [id])
  
  projectId   String?
  project     Project? @relation("ProjectChatMessages", fields: [projectId], references: [id], onDelete: Cascade)
  
  taskId      String?
  task        Task?    @relation("TaskChatMessages", fields: [taskId], references: [id], onDelete: Cascade)
  
  companyId   String
  
  // Thread Support
  parentId    String?
  parent      ChatMessage?  @relation("ChatThread", fields: [parentId], references: [id], onDelete: SetNull)
  replies     ChatMessage[] @relation("ChatThread")
  
  // Reactions & Mentions
  reactions   ChatReaction[]
  mentions    ChatMention[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([taskId])
  @@index([companyId])
  @@index([createdAt])
  @@index([parentId])
  @@map("chat_messages")
}

model ChatReaction {
  id          String   @id @default(cuid())
  emoji       String
  
  messageId   String
  message     ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("ChatReactions", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("chat_reactions")
}

model ChatMention {
  id          String   @id @default(cuid())
  
  messageId   String
  message     ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("ChatMentions", fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@unique([messageId, userId])
  @@index([userId])
  @@index([messageId])
  @@map("chat_mentions")
}

// ============================================
// AUDIT LOG (10 Jahre OR-konform)
// ============================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  PRINT
  LOGIN
  LOGOUT
  APPROVE
  REJECT
  SEND
  LOCK
  UNLOCK
}

enum AuditModule {
  AUTH
  CUSTOMERS
  SUPPLIERS
  PRODUCTS
  QUOTES
  ORDERS
  INVOICES
  PAYMENTS
  EMPLOYEES
  PROJECTS
  FINANCE
  DOCUMENTS
  CONTRACTS
  SETTINGS
  USERS
  SYSTEM
}

model AuditLog {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation("UserAuditLogs", fields: [userId], references: [id])
  
  action        AuditAction
  module        AuditModule
  
  entityId      String?
  entityType    String?
  entityName    String?
  
  description   String?  @db.Text
  oldValues     Json?
  newValues     Json?
  metadata      Json?
  
  ipAddress     String?
  userAgent     String?
  
  retentionUntil DateTime // 10 years from creation (Swiss OR compliance)
  
  companyId     String
  
  createdAt     DateTime @default(now())
  
  @@index([companyId])
  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([entityId])
  @@index([createdAt])
  @@index([retentionUntil])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

model Notification {
  id          String   @id @default(cuid())
  type        NotificationType @default(INFO)
  title       String
  message     String
  read        Boolean  @default(false)
  category    String   @default("system")
  actionUrl   String?
  
  // Relations
  userId      String
  user        User     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Metadata
  sourceType  String?
  sourceId    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, companyId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

